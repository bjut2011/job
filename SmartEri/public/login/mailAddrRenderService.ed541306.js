!function(){"use strict";var t=angular.module("mailAddrRenderModule",[]);t.service("mailAddrRenderService",["$compile","contactsService","setPublicMethod",function(t,e,r){var n=this;n.getRecRender=function(t){var r={},n=t;return/.+\</.test(n)||(n=n.replace(/[<>]/g,"")),r.text=n,r.valid=n.isMail()?1:0,e.getInfoByMail(n.getMailPure())?r.inContact=e.getInfoByMail(n.getMailPure()).id?1:0:e.getInfoByMail(n.getMailPure(),function(){r.inContact=e.getInfoByMail(n.getMailPure()).id?1:0}),r},n.recToRenderArr=function(t){if(!t)return t;for(var e,r=[],a=0,d=t.length;d>a;a++)e=n.getRecRender(t[a]),r.push(e);return r},n.recToOriginArr=function(t){if(t&&0!=t.length){for(var e,r=[],n=0,a=t.length;a>n;n++)e=t[n].text,/\</.test(e)||(e="<"+e+">"),r.push(e);return r}},n.uniqueByAddrObj=function(t){return $.uniqueExtend(t,function(t,e){return t.text.getMailPure()==e.text.getMailPure()})},n.contactsFilter=function(t,e,n,a){function d(t){return t.replace(f,function(t){return t.replace(m,function(t){return"<b>"+t+"</b>"})})}var i={"\\":"\\\\","^":"\\^",$:"\\$","*":"\\*","+":"\\+","?":"\\?"};if(!t)return t;var o=t;if(!e||""==e.trim)return a&&(o=[]),o;for(var c=e.split(""),u=0,s=c.length;s>u;u++)c[u]=i[c[u]]||c[u];for(var l,p,g=c.join(".*?"),v=$.unique(c).join("|"),f=new RegExp(g,"gi"),m=new RegExp(v,"gi"),I=[],x=0,b=o.length;b>x;x++){var h=o[x];l=h.nickname,p=h.email,(f.test(l)||f.test(p))&&(n&&(l=r.htmlTransferredMeaning(l),h.nickname_m=d(l),h.email_m=d(p)),I.push(h),f.lastIndex=0,m.lastIndex=0)}return I}}]),t.directive("mailAddrs",["$compile","$sce","mAlert","contactsService","httpService","mailAddrRenderService","setPublicMethod",function(t,e,r,n,a,d,i){return{restrict:"EA",replace:!0,scope:{arr:"=",btns:"@",contactstree:"="},template:'<div class="drct-mail-addrs">                        <div class="dp-ib addr-block" index="{{$index}}" valid="{{o.valid}}" in="{{o.inContact}}" ng-repeat="o in arr track by $index" ng-dblclick="reedit($event,$index)" ng-class="{reeditiing:o.reediting}">                            <span class="addr-text">{{o.text}}</span>                            <span title="添加联系人" class="btn add-contact" ng-show="contactAble && o.valid && !o.inContact" ng-click="addContact($index)"></span>                            <span title="编辑联系人" class="btn edit-contact" ng-show="contactAble && o.valid && o.inContact" ng-click="editContact($index,o,contactstree)"></span>                            <span title="删除" class="btn del-addr" ng-show="addrAble" ng-click="delAddr($index)"></span>                            <span title="设为拒收" class="btn add-black" ng-show="blackAble && o.valid" ng-click="addBlack($index)"></span>                        </div>                        <span class="addr-input pos-r dp-ib" ng-show="addrAble">                            <input type="text" class="noshadow" ng-model="addrInput" maxlength="200" ng-keydown="keydownFn($event)" ng-focus="addrInputOn($event)" ng-blur="addrInputBlur()"  ng-change="inputChg()"/>                            <span class="addr-txt" ng-bind="addrInput"></span>                            <div class="addr-tips" ng-show="addrInputTipShow" scrollbar scrollbar-flag="tipList">                                <div class="tip-list">                                    <div class="tip-one ov-elp" ng-class="{on:$index==addrInputTipOnIndex}" ng-repeat="one in inputTipData track by $index" ng-bind-html="addrInputTipRender(one)" ng-click="addrInputTipSelect(one,$event)" ng-mouseenter="addrInputTipMouseenter()" ng-mouseleave="addrInputTipMouseleave()"></div>                                </div>                            </div>                        </span>                    </div>',link:function(o,c,u){function s(){function t(t,e,r){var n=[t,e];r=r.replace(/\s/g,"");var a=r.split(/[,|，|；|;|\s]/);a=$.grep(a,function(t,e){return""!=t.trim()});var i=d.recToRenderArr(a);n=n.concat(i),o.arr.splice.apply(o.arr,n),o.addrInput="",o.addrInputFocus(),d.uniqueByAddrObj(o.arr),o.addrInputTipShow=!1}function r(t){o.addrInput=t.nickname+"<"+t.email+">",o.addrInputTipShow=!1,o.addrBlockInsert()}o.addrInput="",o.addrBlocksEle=$(".drct-mail-addrs"),o.addrInputBox=$(".drct-mail-addrs .addr-input:first"),o.addrInputOn=function(t){o.addrBlocksEle=angular.element(t.target).closest(".drct-mail-addrs"),o.addrInputBox=o.addrBlocksEle.find(".addr-input")},o.keydownFn=function(t){var e=t.keyCode;if(/^(13|32|186|188)$/.test(e)&&!t.shiftKey){if(o.addrInputTipShow){var n=o.inputTipData[o.addrInputTipOnIndex];r(n)}else o.addrBlockInsert();t.preventDefault()}if(8==e&&""==t.target.value&&o.arr.pop(),o.addrInputTipShow&&/^(38|40)$/.test(e)){var a=o.inputTipData.length,d=o.addrInputTipOnIndex;d+=38==e?-1:1,o.addrInputTipOnIndex=d>=0?d%a:d+a,t.preventDefault()}},o.reeditIndex=null,o.inputChg=function(){var t=o.addrInput.trim();if(""!=t){o.addrInputTipOnIndex=0;var e=o.contactstree?[].concat(o.contactstree.contacts):[];o.inputTipData=o.contactsFilter(e,t,!0,!0),o.addrInputTipShow=o.inputTipData.length>0,o.addrInputTipShow&&(!i.brower().ie||i.brower().ie>8)&&setTimeout(function(){o.$emit("scrollbar",{flag:"tipList",scrollEvent:"update"})},100)}else o.addrInputTipShow=!1;var r=t.split(/[,|，|；|;|\s]/);r.length>1&&o.addrBlockInsert()},o.addrBlockInsert=function(e){var r=o.addrInput.trim();""!=r&&(null!=o.reeditIndex?(t(o.reeditIndex,1,r),o.arr[o.reeditIndex].reediting=!1,o.reeditIndex=null,o.addrBlocksEle.append(o.addrInputBox)):(void 0==e&&(e=o.arr.length),t(e,0,r)))},o.reedit=function(t,e){if(o.addrAble){var r=o.arr[e].reediting;if(!r){o.arr[e].reediting=!0;var n=angular.element(t.target).closest(".addr-block");n.closest(".drct-mail-addrs");return o.addrInput=o.arr[e].text,n.append(o.addrInputBox),o.reeditIndex=e,o.addrInputFocus(),!1}}},o.addrInputBlur=function(){o.addrInputBlurInsert&&o.addrBlockInsert()},o.addrInputFocus=function(){setTimeout(function(){o.addrInputBox.find("input").focus()},10)},o.delAddr=function(t){o.arr.splice(t,1)},o.contactsFilter=d.contactsFilter,o.addrInputTipShow=!1,o.addrInputTipRender=function(t){var r=t.nickname_m+"&lt;"+t.email_m+"&gt;";return e.trustAsHtml(r)},o.addrInputTipSelect=function(t,e){r(t)},o.addrInputTipMouseenter=function(t){o.addrInputBlurInsert=!1,o.addrInputFocus()},o.addrInputTipMouseleave=function(t){o.addrInputBlurInsert=!0}}function l(){return t('<div class="input-group">                                            <div class="field">                                                <lable for="mail" class="dp-ib">邮箱：</lable><input type="text"  ng-model="toSaveAddr" disabled="disabled">                                            </div>                                            <div class="field">                                                <lable for="phone" class="dp-ib">姓名：</lable><input type="text" maxlength="30" ng-model="toSaveNick">                                                <i class="error-reminder" ng-show="toSaveNickFlag">请输入姓名</i>                                            </div>                                            <span class="select-group-title">分组：</span>                                            <div class="select-group" id="selectGroup">                                            <div ng-repeat="group in contactsGroups" class="select-group-list">                                            <span id="{{group.id}}" class="ckbox groupCkbox" ng-click="itemSelect(group)" ng-class="{\'choosed\': !!(groupArr.indexOf(group.id)+1)}"></span>                                            <span class="select-groups-span" ng-click="itemSelect($index)">{{ group.name }}</span>                                            </div>                                            <div id="addGroupInput" ng-show="!addGroupBtnFlag" class="add-group">                                                <input type="text" maxlength="20" ng-model="addGroupName" />                                                <span class="add-group-btn" ng-click="addGroup()">确定</span>                                                <span class="add-group-btn" ng-click="hideAddGroup()">取消</span>                                                <i class="error-reminder" ng-show="groupErrorText">{{groupErrorText}}</i>                                            </div>                                            <div id="addGroupBtn" ng-show="addGroupBtnFlag" class="add-group"> <span ng-click="showAddGroup()">添加分组</span></div>                                        </div>                                ')(o)}function p(t,e,a,d){o.groupErrorText=!1,o.addGroupBtnFlag=!0,r.alert({title:t,body:e,btns:[{"class":"btn-sure",text:"确定",closeDefer:!0,cb:function(){if(""==o.toSaveNick||null==o.toSaveNick)return o.toSaveNickFlag=!0,void o.$apply();var t={nickname:o.toSaveNick,personalemail:o.toSaveAddr,birthday:"1990-01-01",type:4},e=function(t){r.msg({type:"success",msg:"操作成功"}),r.close(),n.fetchData(function(){o.arr[a].text=o.toSaveNick+"<"+o.toSaveAddr+">",o.arr[a].inContact=1,o.contactstree?o.contactstree=n.getContactsTree():n.getContactsTree()},function(t){})},i=function(){r.msg({type:"error",msg:"操作失败，请稍后重试！"})};d&&(t.id=d,t.type=1),o.groupArr.length&&(t.ncGroup=o.groupArr.join(",")),n.addContact(t,e,i)}},{"class":"btn-cancle",text:"取消"}]})}function g(t,e){r.alert({title:t,body:e,btns:[{"class":"btn-sure",text:"确定",cb:function(){var t={email:o.toSaveAddr};a.blackList.addBlack(t).then(function(){r.msg({type:"success",msg:"操作成功"})},function(){r.msg({type:"error",msg:"操作失败，请稍后重试！"})})}},{"class":"btn-cancle",text:"取消"}]})}var v=o.btns;o.addrAble=/addr/.test(v),o.contactAble=/contact/.test(v),o.blackAble=/black/.test(v),o.addrAble&&s(),o.addrInputBlurInsert=!0,o.toSaveNickFlag=!1,o.groupId=[],o.addGroupName="",o.groupArr=[],o.contactsGroups=n.getGroups()||n.getOriginData(function(t){o.contactsGroups=n.getGroups()}),o.addContact=function(t){var e=o.arr[t].text;o.toSaveAddr=e.getMailPure(),o.toSaveNick=e.getMailNick();var r=l();o.groupArr=[],p("添加联系人",r,t)},o.editContact=function(t,e,r){for(var a,d=e.text.substring(e.text.indexOf("<")+1,e.text.indexOf(">")),i=r.contacts,c=0,u=i.length;u>c;c++)if(i[c].email===d){a=i[c].id;break}o.toSaveNickFlag=!1;var s=o.arr[t].text;o.toSaveAddr=s.getMailPure(),o.toSaveNick=s.getMailNick();var g=l();o.groupArr=[],p("编辑联系人",g,t,a);var v=n.searchContactByEmail(o.toSaveAddr);o.groupId=v.groupsIdArr,o.groupArr=o.groupArr.concat(o.groupId)},o.itemSelect=function(t){var e=o.groupArr.indexOf(t.id);~e?o.groupArr.splice(e,1):o.groupArr.push(t.id)},o.groupErrorText=!1,o.addGroupBtnFlag=!0,o.showAddGroup=function(){o.addGroupBtnFlag=!1},o.hideAddGroup=function(){o.addGroupBtnFlag=!0,o.groupErrorText=!1},o.addGroup=function(){if(o.addGroupName){if(/[\\'"% ;]/.test(o.addGroupName))return o.groupErrorText="组名称请不要输入\\\"% ' 等特殊字符",!1;var t={groupname:o.addGroupName};n.createGroupByDetial(t,function(t){var e=Number(t.msg);n.getGroups(function(t){o.contactsGroups=n.getGroups(),o.hideAddGroup(),o.addGroupName="",o.groupArr.push(e);var r=angular.element("#selectGroup");setTimeout(function(){r.scrollTop(r[0].scrollHeight)},0)})})}else o.groupErrorText="组名称不能为空"},o.addBlack=function(e){var r=o.arr[e].text;o.toSaveAddr=r.getMailPure();var n=t("<div >                                                        是否将{{toSaveAddr}}添加至黑名单                                                    </div>")(o);g("设为拒收",n)}}}}])}();