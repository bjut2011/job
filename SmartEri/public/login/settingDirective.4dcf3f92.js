!function(){"use strict";function e(e,t,n,i,s,a,r,l){e.bindOption.showMsgFlag=!1,e.bindOption.errorPhoneFlag=!1,e.bindOption.submitMsg=!1,o=!1;var u={},p=$(".autoreply");p.find(".switch").each(function(){!function(e){var t=$(e).attr("data-param"),n=$(e).find(".open").attr("data-value");n&&(u[t]=n)}(this)});var c=p.find(".text").attr("data-param");u[c]=p.find(".text .textarea").val();var d=[],m=p.find(".starttime");m.find(".val").each(function(e){d[e]=$(this).html()}),u[m.attr("data-param")]=d;var g=[],f=p.find(".endtime");if(f.find(".val").each(function(e){g[e]=$(this).html()}),u[f.attr("data-param")]=g,e.options.replyContent=u.replyContent,e.options.startDate=s.formatTime(u.startDate),e.options.endDate=s.formatTime(u.endDate),e.options.autoReply&&!e.options.replyContent)return i.msg({type:"error",msg:"自动回复内容不能为空"}),o=!0,!1;if(e.options.forward&&(!e.options.forwardAddr||!a.mailVerify(e.options.forwardAddr)))return e.options.forwardAddr?i.msg({type:"error",msg:"邮箱格式不正确"}):i.msg({type:"error",msg:"转发地址不能为空"}),o=!0,!1;var b=a.clone(e.options);b.replyContent=encodeURIComponent(b.replyContent);var v=l('<div class="input-phone">            <div>为了避免自动转发回复可能造成的信息泄露，需进行手机短信验证</div>            <div>                <span>验证码：</span>                <input class="input-captcha" type="text" maxlength="6" placeholder="请输入验证码" ng-model="bindOption.msgCaptcha">                <span ng-click="getcaptcha(true)" class="get-button" ng-class="{true: \'gray\', false: \'\'}[!!bindOption.grayFlag]">{{bindOption.contentCaptcha}}</span>                <span ng-show="bindOption.countFlag" class="residue">剩余{{bindOption.count}}次</span>            </div>            <div ng-show="!!bindOption.submitMsg" class="message">{{bindOption.submitMsg}}</div>            <div>                <span>接收验证码的手机号：</span>                <span>{{bindOption.showPhone | phone}}</span>                <a ng-click="showErrorMsg()" class="link">手机号码有误</a>            </div>             <div ng-show="bindOption.errorPhoneFlag" class="message padding-left">请联系客服热线： 010-58103760</div>        </div>')(e),h=l('<div class="input-phone">            <div>为了避免自动转发回复可能造成的信息泄露，需进行手机绑定</div>            <div>                <span>手机号：</span>                <input class="input-width" type="text" maxlength="11" placeholder="请输入手机号" ng-model="bindOption.bindPhone">                <span ng-click="getcaptcha()" class="get-button" ng-class="{true: \'gray\', false: \'\'}[!!bindOption.grayFlag]" >{{bindOption.contentCaptcha}}</span>                <span ng-show="bindOption.countFlag" class="residue">剩余{{bindOption.count}}次</span>            </div>            <div ng-show="bindOption.showMsgFlag" class="message">{{bindOption.message}}</div>            <div>               <span>验证码：</span>                <input class="input-captcha" type="text" maxlength="6" placeholder="请输入验证码" ng-model="bindOption.msgCaptcha">            </div>            <div ng-show="!!bindOption.submitMsg" class="message">{{bindOption.submitMsg}}</div>        </div>')(e);return i.alert({title:"手机验证",body:e.bindOption.showPhone?v:h,btns:[{"class":"btn-sure",text:"确定",closeDefer:!0,cb:function(){return b.msgCaptcha=e.bindOption.msgCaptcha,e.bindOption.showPhone||(b.bindPhone=e.bindOption.bindPhone,b.bindPhone)?!b.msgCaptcha||b.msgCaptcha.length<6?(e.bindOption.submitMsg="请输入正确的验证码",o=!0,e.$apply(),!1):void t.setAutoreply.set(b).then(function(t){if(t&&200==t.status)i.msg({type:"success",msg:"保存成功"}),i.close(),e.configService.getUserData(),n.go("setting");else{var s="操作失败，请稍后重试！";409==t.status&&(s="验证码不正确"),403==t.status&&(s="该手机号已经绑定至其它帐号"),400==t.status&&(s="验证码错误"),406==t.status&&(s="提交次数过多"),1300==t.status&&(s="当前邮箱已绑定了其他手机号"),1301==t.status&&(s="当前邮箱未绑定手机号"),e.bindOption.submitMsg=s}o=!0},function(){i.msg({type:"error",msg:"操作失败，请稍后重试！"})}):(e.bindOption.message="手机号不能为空",e.bindOption.showMsgFlag=!0,e.$apply(),!1)}},{"class":"btn-cancle",text:"取消"}]}),!1}function t(e,t,n,i,o,s,a){var r,l=[];if(r=e[e.setFilterMap.filterNewRuleBody[e.newRule.body].logic].value,e[e.setFilterMap.filterNewRuleBody[e.newRule.body].text]){l.push(e.newRule.isStart),l.push(e.newRule.body),l.push(e[e.setFilterMap.filterNewRuleBody[e.newRule.body].text]),l.push(e.setFilterMap.getVlaueToKey(r,e.setFilterMap.logic)),l.push(e.setFilterMap.getVlaueToKey(e.selectMoveSite.value,e.setFilterMap.moveTo));var u=e.initlist.concat([]);e.footer.newOrAlert?u[e.filterOptionsSelect]=l:u.unshift(l),t.filter.set({list:u}).then(function(t){200===t.status?(a.getFolderListData(),e.footer.newOrAlert?e.initlist[e.filterOptionsSelect]=l:e.initlist.unshift(l),e.$watch("initlist",function(t,n,o){e.filterOptions=e.setReceiveRuleService.filterOptions(t,e.setFilterMap),e.footer.returnFilter.receiveruleShow=!0,e.footer.returnFilter.newruleShow=!1,e.footer.falseReturn=!1,e.footer.preview=!0,i.msg({type:"success",msg:"保存成功"})})):406===Number(t.status)?i.msg({type:"error",msg:"最多只能添加10条规则"}):i.msg({type:"error",msg:"请求接口错误，请稍后重试"})})}else i.msg({type:"error",msg:"请输入过滤关键字"});e.footer.preview=!1}function n(e,t,n,i,o,a){var r=function(){e.options.signature=e.editor.getContent(),t.sign.updateSign(e.options).then(function(e){200!==e.status&&i.msg({type:"error",msg:"操作失败，请稍后重试！"}),i.msg({type:"success",msg:"保存成功"}),n.go("setting"),s=!0})};s&&(s=!1,e.submitPicOptions.filename?t.sign.ImageHandle(e.submitPicOptions).then(function(t){t.is_success||i.msg({type:"error",msg:"操作失败，请稍后重试！"}),e.options.image_signature_name=t.filename,r()}):r())}var i={setAutoreplyInfo:e,filterNewRule:t,signature:n},o=!0,s=!0,a=angular.module("SettingModule");a.directive("footer",function(){return{restrict:"EA",template:['<div class="footer">','<button class="save" ng-hide=footer.preview ng-click="saveFun()">保存</button>','<button ng-click="returnFun()" >返回</button>',"</div>"].join(""),replace:!0,controller:["$scope","$state","httpService","mAlert","setPublicMethod","timeFunction","configService","$compile",function(e,t,n,o,s,a,r,l){i[e.footer.functionName]&&(e.saveFun=function(){i[e.footer.functionName](e,n,t,o,a,s,r,l)}),e.returnFun=function(){angular.isUndefined(e.footer.returnFilter)?t.go("setting"):e.footer.falseReturn?(e.footer.returnFilter.receiveruleShow=!0,e.footer.returnFilter.newruleShow=!1,e.footer.falseReturn=!1,e.footer.preview=!0):t.go("setting")}}]}}),a.directive("setFilter",function(){return{restrict:"EA",templateUrl:"tpls/setting/filter-table.html",replace:!0,controller:["$scope","$location","mAlert","httpService",function(e,t,n,i){e.moveUp=function(t){if(t){var o=e.initlist.concat([]),s=o[t-1];o.splice(t-1,1),o.splice(t,0,s),i.filter.set({list:o}).then(function(i){if(200===i.status){var o=e.filterOptions[t-1];e.filterOptions.splice(t-1,1),e.filterOptions.splice(t,0,o);var s=e.initlist[t-1];e.initlist.splice(t-1,1),e.initlist.splice(t,0,s)}else n.msg({type:"error",msg:"请求接口错误，请稍后重试"})})}},e.moveDown=function(t){if(t!==e.filterOptions.length-1){var o=e.initlist.concat([]),s=o[t+1];o.splice(t+1,1),o.splice(t,0,s),i.filter.set({list:o}).then(function(i){if(200===i.status){var o=e.filterOptions[t+1];e.filterOptions.splice(t+1,1),e.filterOptions.splice(t,0,o);var s=e.initlist[t+1];e.initlist.splice(t+1,1),e.initlist.splice(t,0,s)}else n.msg({type:"error",msg:"请求接口错误，请稍后重试"})})}},e.alterOption=function(t){e.filterOptionsSelect=t,e.alterRule=e.initlist[t],e.setReceiveRuleService.initRule(e,"修改规则"),e.newRule.isStart=e.alterRule[0],e.newRule.body=e.alterRule[1],e.newRule.logic=e.alterRule[3],e[e.setFilterMap.filterNewRuleBody[e.newRule.body].text]=e.alterRule[2],e[e.setFilterMap.filterNewRuleBody[e.newRule.body].logic].value=e.setFilterMap.logic[e.newRule.logic],e.selectMoveSite.value=e.setFilterMap.moveTo[e.alterRule[4]],e.footer.newOrAlert=!0,e.footer.returnFilter.receiveruleShow=!1,e.footer.returnFilter.newruleShow=!0,e.footer.preview=!1;for(var n=0,i=e.enableEdit.length;i>n;n++)n==e.newRule.body?(e.enableEdit[n]=!1,e[e.selectMap[n]].click=!1):(e.enableEdit[n]=!0,e[e.selectMap[n]].click=!0)},e.deleteOption=function(t){n.alert({title:"提示",body:"您确定要删除这条过滤规则吗?",btns:[{"class":"btn-sure",classmore:"btn-lg",text:"确定",cb:function(){var o=e.initlist.concat([]);o.splice(t,1),i.filter.set({list:o}).then(function(i){200===i.status?(e.filterOptions.splice(t,1),e.initlist.splice(t,1)):n.msg({type:"error",msg:"请求接口错误，请稍后重试"})})}},{"class":"btn-cancle",text:"取消"}]})},e.moveupenter=function(e){angular.element(e.target).addClass("moveupnow")},e.moveupleave=function(){e.moveUpDom=angular.element('span[name="moveUp"]'),e.moveUpDom.removeClass("moveupnow")},e.movedownenter=function(e){angular.element(e.target).addClass("movedownnow")},e.movedownleave=function(){e.moveDownDom=angular.element('span[name="moveDown"]'),e.moveDownDom.removeClass("movedownnow")}}]}}),a.directive("newrule",function(){return{restrict:"EA",templateUrl:"tpls/setting/set-newRule.html",replace:!0,controller:["$scope","mAlert",function(e,t){e.judgeCondition=function(t){e.newRule.isStart=t},e.chooseBody=function(t){if(e.newRule.body!=t){e.newRuleAddress="",e.newRuleTheme="",e.newRuleContent="",e.newRule.body=t;for(var n=0,i=e.enableEdit.length;i>n;n++)n==t?(e.enableEdit[n]=!1,e[e.selectMap[n]].click=!1):(e.enableEdit[n]=!0,e[e.selectMap[n]].click=!0)}}}]}}),a.directive("uploadimage",function(){return{restrict:"EA",replace:!0,templateUrl:"tpls/setting/upload-image.html",controller:["$scope","mAlert","httpService","setPublicMethod","fileUploadService",function(e,t,n,i,o){e.mAlert=t,e.setPublicMethod=i,e.fileUploadService=o}],link:function(e,t,n){function i(t){$("#image").Jcrop({onChange:o,onSelect:o,aspectRatio:4/3,allowSelect:!1},function(){e.bounds=this.getBounds(),e.boundx=e.bounds[0],e.boundy=e.bounds[1],e.jcrop_api=this,e.jcrop_api.setSelect([e.boundx/4,e.boundy/4,e.boundx/4*3,e.boundy/4*3]),$("#preview-pane").appendTo(e.jcrop_api.ui.holder)})}function o(t){if(parseInt(t.w)>0){var n=r/t.w,i=l/t.h;$("#completeImage").css({width:Math.round(n*e.boundx)+"px",height:Math.round(i*e.boundy)+"px",marginLeft:"-"+Math.round(n*t.x)+"px",marginTop:"-"+Math.round(i*t.y)+"px"}),e.submitPicOptions.x=Math.round(t.x),e.submitPicOptions.y=Math.round(t.y),e.submitPicOptions.height=Math.round(t.h),e.submitPicOptions.width=Math.round(t.w)}}e.maxSize=2097152;var s=angular.element("#inputImage")[0],a=window.URL||window.webkitURL;a?s.onchange=function(){var t=this.files;t&&t.length&&(e.file=t[0],e.file.size<=e.maxSize&&/^image\/(jpeg)|(jpg)|(gif)/.test(e.file.type)?(e.pictureName=e.file.name,e.cutImage=!0,e.uploadText="重新上传",e.$apply(),$("#myForm").submit(),s.disabled=!0):e.mAlert.alert({title:"提示",body:"请上传小于2M的jpg、gif格式的图片文件",btns:[{"class":"btn-sure",classmore:"btn-lg",text:"确定"}]}))}:angular.element("#myForm").on("change","input[type=file]",function(){var t=this.value,n={jpg:!0,gif:!0};/^\s*$/.test(this)||(t=t.substring(t.lastIndexOf("\\")+1,t.length));try{var o=t.substring(t.lastIndexOf(".")+1,t.length);if(!n[o.toLowerCase()])return e.mAlert.msg({type:"error",msg:"请上传jpg、gif格式的图片文件！"}),!1}catch(o){}e.cutImage=!0,e.pictureName=t,e.uploadText="重新上传",e.$apply();var a=e.setPublicMethod.brower();if(a.ie&&a.ie<10){var r=$("#myForm").attr("action");e.fileUploadService.uploadByIframe({url:r,fileInputSlct:"#inputImage",dataType:"json",complete:function(t){if(angular.element("#inputImage")[0].disabled=!1,t)if(0==t.status){e.submitPicOptions.filename=t.data.filename;var n=setInterval(function(){e.jcrop_api?(e.jcrop_api.setImage("//"+t.data.url+"?"+(new Date).getTime(),function(){e.bounds=e.jcrop_api.getBounds(),e.boundx=e.bounds[0],e.boundy=e.bounds[1]}),e.jcrop_api.setSelect([e.boundx/4,e.boundy/4,e.boundx/4*3,e.boundy/4*3]),$("#completeImage").attr("src","//"+t.data.url+"?"+(new Date).getTime())):($("#image").attr("src","//"+t.data.url+"?"+(new Date).getTime()),$("#completeImage").attr("src","//"+t.data.url+"?"+(new Date).getTime()),setTimeout(function(){i(t)},100)),clearInterval(n)},100)}else e.mAlert.msg({type:"error",msg:t.msg}),s.disabled=!0,e.cutImage=!1,e.pictureName="未选择文件",e.uploadText="浏览",e.$apply()}})}else $("#myForm").submit();s.disabled=!0}),$("#myForm").ajaxForm(function(t){if(angular.element("#inputImage")[0].disabled=!1,t)if(t=JSON.parse(t),0==t.status){e.submitPicOptions.filename=t.data.filename;var n=setInterval(function(){e.jcrop_api?(e.jcrop_api.setImage("//"+t.data.url+"?"+(new Date).getTime(),function(){e.bounds=e.jcrop_api.getBounds(),e.boundx=e.bounds[0],e.boundy=e.bounds[1]}),e.jcrop_api.setSelect([e.boundx/4,e.boundy/4,e.boundx/4*3,e.boundy/4*3]),$("#completeImage").attr("src","//"+t.data.url+"?"+(new Date).getTime())):($("#image").attr("src","//"+t.data.url+"?"+(new Date).getTime()),$("#completeImage").attr("src","//"+t.data.url+"?"+(new Date).getTime()),setTimeout(function(){i(t)},100)),clearInterval(n)},100)}else e.mAlert.msg({type:"error",msg:t.msg})});var r=200,l=150}}}),a.directive("showimage",function(){return{restrict:"EA",replace:!0,templateUrl:"tpls/setting/cut-image.html",controller:["$scope",function(e){}]}})}();