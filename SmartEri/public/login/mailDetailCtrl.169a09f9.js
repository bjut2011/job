!function(){"use strict";var e=angular.module("mailDetail",[]);e.controller("mailDetailCtrl",["$scope","$state","$stateParams","$sce","$http","$compile","configService","toolsBarService","mailData","mAlert","writeMailService","contactsService","mailAddrRenderService","setPublicMethod",function(e,t,a,n,i,o,l,r,c,s,m,u,d,p){function f(t){if(!e.trueReplyTo||e.trueReplyTo.getMailPure()==e.mail.from.getMailPure())return void t();var a=e.mail.from.getMailPure(),n=e.trueReplyTo.getMailPure(),i='您回复的地址和原邮件地址不一致。						<div style="margin: 12px 0 0 0;">发送地址：'+a+"						<br/>回复地址："+n+"						</div>";s.alert({body:i,btns:[{"class":"btn-sure",text:"继续回复",cb:function(){t()}},{text:"取消"}]})}function h(){var t=angular.copy(e.mail);m.externalData={type:"replyAll",data:t,quickReply:!0};var a=m.getPreDataForMail();a.from="<"+(l.email||localStorage.userid)+">",a.send=1,a.content=e.replyText+a.content;var n=function(t){s.msg({type:"success",msg:"回复成功"}),e.replyText="",e.replyBtnText="再回一封",setTimeout(function(){$(".reply").focus().blur()},10)},i=function(e){s.msg({type:"error",msg:"回复失败，请重试"})};m.send(a,n,i)}function g(a){m.externalData={type:a,data:e.mail},t.go("write",{id:""})}function v(){var t=e.mail.attachments.length;if(0==t)return"";for(var a=0,n=0;t>n;n++){var i=isNaN(e.mail.attachments[n].size)?0:e.mail.attachments[n].size;a+=i}return a}function b(){if(e.tools.spareBar&&(r.ids=[],r.ids.push(e.tools.nowMailID)),!e.mail.hasRead){r.ids=[],r.ids.push(e.mail.id);var t=e.tools.spareBar?"markRead":"markReadFromUnreadSpareBar";e.tools.apiWithMails(t,null,null,1,!0),e.tools.nowMail&&(e.tools.nowMail.hasRead=!0)}y(),e.tools.MailGrayFlag()}function y(){""==w&&(w=o('<div class="add-contact"><div class="input-group"><div><lable for="mail" class="head">邮箱地址</lable><input type="text"  ng-value="fromMail" disabled="disabled"></div><div><lable for="phone" class="head">姓名</lable><input type="text" ng-model="addContactName" value=""></div></div></div>')(e))}e.ie8=8==p.brower().ie;var w="";if(e.setPublicMethod=p,!c)return t.reload(),void s.alert({body:"邮件获取失败，请稍候重试！",btns:[{"class":"btn-sure",text:"确定",cb:function(){t.go("^")}}]});e.mail=c.data,e.tools=r,e.tools.stateParams=a,e.bytesToSize=p.bytesToSize,e.tools.inMail=!0,e.display=n.trustAsHtml(p.htmlTransferredMeaning(e.mail.display)),e.firstAcc=0,e.accessory=e.mail.attachments,e.configService=l,e.tools.listHide=/.*.mail/.test(t.$current.name)&&r.spareBar,e.mail.subject=e.mail.subject||"(无主题)",e.accessoryName=e.mail.subject+"_全部附件.zip",e.trueReplyTo=e.mail.replyTo,e.quickReplyAble=!0,e.replyText="",e.replyTosText="点击快速回复",e.replyBtnText="发送";var T=[].concat(e.mail.to?e.mail.to:[]);if(e.mail.cc&&(T=T.concat(e.mail.cc)),$.unique(T),T=m.getMailsNoSelf(T),T=T.concat(e.mail.from.getMailNick()),T=m.getFormatMails(T,"nick"),$.unique(T),e.replyTosText="快速回复给："+T.join("、"),e.ie8)var M=setTimeout(function(){$("textarea.reply").placeholder(),clearTimeout(M)},200);u.getOriginData(function(t){e.contactsTree=u.getContactsTree()},function(e){}),e.totalSize=v(),e.receiver=e.mail.to?e.mail.to.join(","):"",e.to_render=d.recToRenderArr(e.mail.to),e.cc_render=d.recToRenderArr(e.mail.cc),e.bcc_render=d.recToRenderArr(e.mail.bcc),e.showBccRender="send"===t.$current.name.replace(/\.mail/,""),e.tools.nowMailID=a.id,e.groups=[],e.choosedGroupId=null,e.addContactName="",e.fromMail=e.mail.from.match(/<(.*)>/)[1],e.tools.detail=e.tools.spareBar;var S=[];S.push(e.mail.from),e.from_render=d.recToRenderArr(S);var x={"true":"收起","false":"查看附件"};e.moreAttachmentFlag=!1,e.seeAttachmentText=x[e.moreAttachmentFlag],e.showMoreAttachment=function(t){return!t||e.moreAttachmentFlag},e.showMoreAttachmentClick=function(){var t={flag:"mailDetail",scrollEvent:"scrollTo",scrollTo:"bottom"};e.ie8?$("#mailView").scrollTop($("#print_mail").height()):e.$emit("scrollbar",t)},e.receiptFlag=!1;var C=e.mail.from.slice(e.mail.from.indexOf("<")+1,e.mail.from.indexOf(">"));e.mail.receipt&&C!==localStorage.getItem("userid")&&(e.receiptFlag=!0),e.receiptBtn=r.receipt(e.mail.id,function(){s.msg({type:"success",msg:"操作成功"}),e.receiptFlag=!1}),b(),e.toggleStar=function(){var a=e.tools.nowMail;e.tools.chooseNothing(),e.tools.ids.push(a.id);var n=0!=a.star?0:1,i=t.$current.name.replace(/\.mail/,"");e.tools.apiWithMails("markStar",l.mailFolders[i].folder_id,null,n)},e.addContact=function(){y(),s.alert({title:"添加联系人",body:w,btns:[{"class":"btn-sure",text:"确定",cb:function(){if(""==e.addContactName||null==e.addContactName)return void s.msg({type:"warning",msg:"请输入姓名"});var t={fullname:null,nickname:e.addContactName,personalemail:e.fromMail,otheremail:null,ncGroup:null,mobilephone:null,otherphone:null,businessphone:null,fax:null,personalstreet:null,personalzip:null,businessstreet:null,businesszip:null,birthday:"0000-00-00",notes:null,homepage:null,type:4},a=function(){s.msg({type:"success",msg:"操作成功"})},n=function(){s.msg({type:"error",msg:"操作失败，请稍后重试！"})};u.addContact(t,a,n)}},{"class":"btn-cancle",text:"取消"}]})},e.setRefuse=function(){},e.quickReply=function(){return""==e.replyText.trim()?(s.msg({type:"error",msg:"回复内容不能为空"}),!1):void f(h)},e.toMailState=function(e){f(function(){g(e)})},e.downLoad=function(e){window.open("attach/download?id="+e.id+"&name="+encodeURIComponent(e.name))},e.downLoadMailFile=function(){window.open("downloadOrigin?id="+e.mail.origin+"&name="+encodeURIComponent(e.mail.subject))},e.chooseGroup=function(t){e.choosedGroupId=t},e.addContactsToGroup=function(){u.addContactsToGroup()},e.$on("$stateChangeStart",function(a,n,i,o,l){n.name+".mail"==t.$current.name&&(e.tools.listHide=!1,e.tools.inMail=!1),e.tools.detail=!1})}]).filter("sizeFormate",function(){return function(e){var t=e;return t=isNaN(t)?"":t>=1e6?(t/1e6).toFixed(1)+"M":(t/1e3).toFixed(1)+"K"}}).directive("hover",function(){return{restrict:"A",link:function(e,t,a){t.hover(function(){$(this).children(".ac-hover").show(200).fadeIn()},function(){$(this).children(".ac-hover").hide(200).fadeOut()})}}}).directive("sendControl",["mAlert",function(e){return{restrict:"AE",link:function(e,t,a){function n(){t.parent().siblings(".send-btn").show(100,function(){var e=$(".mail-view"),t=e[0],a=t.scrollHeight-e.height();0==a?($("#mailView").mCustomScrollbar("update"),$("#mailView").mCustomScrollbar("scrollTo","bottom")):e.animate({scrollTop:a},300)})}function i(){t.parent().siblings(".send-btn").hide(100,function(){$("#mailView").mCustomScrollbar("scrollTo","bottom"),setTimeout(function(){$("#mailView").mCustomScrollbar("update")},500)})}var o=t.parent().height(),l=130;t.on("keyup",function(){var e=t.val(),a=/\n/.test(e)?e.match(/\n/g).length:1,n=parseInt(t.css("line-height"));n=n?n:14;var i=o+a*n;i>l&&t.parent().animate({height:i},100)}),t.on("focus",function(){var e=t.parent().height();l>e&&t.parent().animate({height:l},100),n()}),t.on("blur",function(){""==t.val()&&(t.parent().animate({height:o},100),i())})}}}]).directive("print",function(){return{restrict:"A",link:function(e,t,a){angular.element(t).click(function(e){print()})}}}).directive("downloadAll",function(){return{restrict:"A",link:function(e,t,a){angular.element(t).click(function(t){for(var a='<form style="display:none"  action="attach/downloadAll" method="post" id="downLoadAll">',n=0;n<e.mail.attachments.length;n++){var i='<input name="attachList['+n+'].id"}} value="'+e.mail.attachments[n].id+'" /><input name="attachList['+n+'].name"}} value="'+e.mail.attachments[n].name+'" />';a+=i}var o=encodeURIComponent(e.mail.subject+"_全部附件.zip");a+='<input name="zipName" value="'+o+"/><form>",angular.element("body").append(a),$("#downLoadAll").submit().remove()})}}}).directive("fileType",function(){return{restrict:"A",scope:{name:"@",thumb:"@"},link:function(e,t,a){var n=e.name,i=n.slice(n.lastIndexOf(".")+1,n.length).toLowerCase(),o=angular.element(t);return e.thumb?void o.css({"background-image":"url("+e.thumb+")"}):void angular.element(t).addClass(i)}}}).directive("accessoryScroll",function(){return{restrict:"A",link:function(e,t,a){if(e.mail&&e.mail.attachments.length){var n=120;if(angular.element("#accessoryScroll").css({width:e.mail.attachments.length*n+"px"}),e.ie8)angular.element("#wrapper").css({"overflow-x":"auto"});else{new IScroll("#wrapper",{scrollX:!0,scrollY:!1,scrollbars:!0,mouseWheel:!0,interactiveScrollbars:!0})}}}}}).directive("mailDetailFilter",function(){return window.iframeFinish=function(){},{restrict:"EA",template:'<iframe id="iframepage" name="iframepage" onload="iframeFinish()" frameBorder=0 width="100%" ></iframe>',replace:!0,link:function(e,t,a){function n(){try{var e=i.contentWindow.document.body.scrollHeight,t=i.contentWindow.document.documentElement.scrollHeight;i.contentWindow.document.body.style["overflow-y"]="hidden",i.height=Math.max(e,t)}catch(a){}}var i=document.getElementById("iframepage"),o=e.setPublicMethod.brower().ie;window.iframeFinish=function(){t[0].contentWindow&&(e.mail.display=e.setPublicMethod.securityFilter(e.mail.display),t[0].contentWindow.document.write(e.mail.display),(!o||o>=9)&&setTimeout(function(){e.$emit("scrollbar",{flag:"mailDetail",scrollEvent:"update"}),angular.element(t[0].contentWindow.document.body).bind("mousewheel",function(e,t){var a,n=angular.element("#mailView").find("div[id^='mCSB']"),i=n.find(".mCSB_container"),o=n.find(".mCSB_dragger"),l=n.find(".mCSB_draggerContainer"),r=Math.abs(i.position().top),c=o.position().top,s=l.height()-o.height();(t>0&&0!==c||0>t&&c!==s)&&(e.preventDefault(),e.stopImmediatePropagation()),a=r-350*t,angular.element("#mailView").mCustomScrollbar("scrollTo",a,{trigger:"internal"})})},100))};var l=window.setInterval(function(){n()},100);setTimeout(function(){window.clearInterval(l),(!o||o>=9)&&e.$emit("scrollbar",{flag:"mailDetail",scrollEvent:"update"})},2500)}}})}();