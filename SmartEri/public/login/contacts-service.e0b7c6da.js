!function(t){"use strict";var n=null,e=null,o={createGroup:"address/addGroup",removeGroup:"address/rmGroup",updateGroup:"address/modGroup",removeContact:"address/rmContact",updateContact:"address/modContact",importCSV:"address/importCSV_v2",importRemote:"address/remoteImport",fastAdd:"address/fastAdd",getscore:"address/getscore"};angular.module("Contacts").factory("contactsService",["$http","$q","$timeout","setPublicMethod",function(r,i,a,u){function c(t){for(var n,e,o,r={},i=0;i<t.length;++i)n=null,e=null,o=t[i],n=s(o.id),r[n]=t[i];ut=r}function f(t){for(var n,e,o,r={},i=0;i<t.length;++i)n=null,e=null,o=t[i],n=s(o.id),d(o),r[n]=o;ct=r}function s(t){return"_"+t+"_"}function d(t){var n;n=t.contactid.split(","),1===n.length&&""===n[0]&&(n=[]),t.membersKey=n}function p(t){var n,e,o,r=[];for(n in it)it.hasOwnProperty(n)&&(e=it[n],o=e.contactid,-1!==o.indexOf(t)&&r.push(e.id));return r}function l(t){var n,e,o,r=[];for(n in it)it.hasOwnProperty(n)&&(e=it[n],o=e.contactid,-1!==o.indexOf(t)&&r.push(e.name));return r}function m(t,n,e,o){var r=i.defer();st(t,n,r),r.promise.then(function(){tt=!0,v(e,o)},function(t){"function"==typeof errror&&o()})}function h(t,n,e,o,r){var a=i.defer();st(t,n,a),a.promise.then(function(t){t&&t.status===!0?(r===!0&&(tt=!0,v()),"function"==typeof e&&e(t.data||t)):"function"==typeof o&&o(t)},function(t){"function"==typeof o&&o(t)})}function v(t,n){var o;tt===!0?nt?(nt=!1,o=i.defer(),r({method:"GET",url:"address/completelist_v2"}).then(function(t){var n=t.data;e=n,Z.mapByMail=W(n),ot=H(n),et=n,rt=n.contact,it=n.group,at=n.recent,c(n.contact),f(n.group),tt=!1,nt=!0,o.resolve(t)},function(t){o.reject(t)}),o.promise.then(function(n){"function"==typeof t&&t(n.data)},function(t){"function"==typeof n&&n(t)})):a(function(){v(t,n)},100):"function"==typeof t&&t(e)}function g(t,e){var o=[];i.defer();return t||rt.length<1?void r.get("address/list").then(function(r){200===Number(r.status)?(n=r.data,o=r.data.contact,rt=o,c(o),"function"==typeof t&&t(o)):"function"==typeof e&&e()},function(t){"function"==typeof e&&e()}):rt}function y(t,n){return t||at.length<1?tt?void a(function(){y(t,n)},100):it:at}function C(t,n){return(t||it.length<1)&&tt?void a(function(){C(t,n)},100):it}function G(){var t,n,e,o,r,i,a=[];for(r=0;r<it.length;++r){for(n=it[r],e=n.contactid.split(","),t={id:n.id,name:n.name,members:[]},i=0;i<e.length;++i)o=B(e[i]),null!==o&&(o.isNeedhide=!1,t.members.push(o));a.push(t)}return a}function B(t){var n,e,o;return n=s(t),e=ut[n],null===e||void 0===e?null:o={id:t,email:e.email,nickname:e.nickname,groups:l(t)}}function j(t){for(var n={},e=0,o=at.length;o>e;e++)if(t===at[e].email){n=at[e];break}return n}function T(t){var n,e,o,r=[];for(e=0;e<rt.length;++e)n=rt[e],t===n.nickname&&(o={id:n.id,email:n.email,nickname:t,groups:l(n.id)},r.push(o));return r}function k(t,n){var e,o,r=null;for(o=0;o<rt.length;++o)if(e=rt[o],t===e.email){r={id:e.id,email:t,nickname:e.nickname,groups:l(e.id),groupsIdArr:p(e.id)};break}return n?o===rt.length?!1:rt[o]:r}function w(t,n,e,r){var i;"function"==typeof n&&(i=function(t){rt.push(t),n(t)}),r=r||!0,h(o.updateContact,t,i,e,r)}function I(t,n,e){}function b(t){for(var n=[],e=0,o=it.length;o>e;e++)t!=it[e].id&&n.push(it[e].name);return n}function S(t,n,e,r){var a={id:t};1==n?a={recent:1,addrs:t}:(r=e,e=n);var u=i.defer();st(o.removeContact,a,u),u.promise.then(function(t){t.status||t.data.status?(tt=!0,"function"==typeof e&&e(t)):"function"==typeof errror&&r()},function(t){"function"==typeof errror&&r()})}function A(t,n,e,o){sohu.mail.utils.isArray(t)&&S(t.join(","),n,e,o)}function M(t,n,e){var o;o=k(t),S(o.id,n,e)}function O(t,n,e){var o,r;for(o=T(t);o.length>0;)r=o.pop(),S(r.id,n,e)}function R(t,n){var e;"function"!=typeof n&&(n=function(){});var o=i.defer();ft("address/getDetailContact",o,{id:t}).then(function(t){e=t,n(e)})}function D(t){var n,e,o,r,i=[];if(e=s(t),n=ct[e])for(o=n.membersKey,r=0;r<o.length;++r)e=s(o[r]),i.push(ut[e]);return i}function x(t,n,e,r){var i,a,c=[];for(a=0;a<n.length;++a)c.push(n[a].id);i=function(n){it.push({id:n,name:t,contactid:c.join(",")}),f(it),e(n)},c=u.removeRepet(c),h(o.createGroup,{groupname:t,ncGroup:c.join(",")},i,r,!1)}function N(t){var n=i.defer();return st(o.getscore,t,n),n.promise}function P(t,n,e){var r=i.defer();return st(o.createGroup,t,r),r.promise.then(function(t){t.status||"true"==t.status?(tt=!0,"function"==typeof n&&n(t)):"function"==typeof e&&e()},function(t){"function"==typeof e&&e()}),r.promise}function _(t,n,e){var r=i.defer();st(o.fastAdd,t,r),r.promise.then(function(t){t.status===!0?(tt=!0,"function"==typeof n&&n(t)):"function"==typeof e&&e()},function(t){"function"==typeof e&&e()})}function F(t,n,e,r){var i;i=function(o){it.push({id:o,name:t,contactid:n.join(",")}),f(it),e(o)},h(o.createGroup,{groupname:t,ncGroup:ncGroup.join(",")},i,r,!1)}function V(t,n,e){m(o.removeGroup,{gid:t},n,e)}function E(t,n,e){var r,i,a,c,f=[];for(i=t.gid,a=t.name,c=t.members,n=n||t.success,e=e||t.error,r=0;r<c.length;++r)f.push(c[r].id);f=u.removeRepet(f),m(o.updateGroup,{gid:i,groupname:a,ncGroup:f.join(",")},n,e)}function $(t){return ct[s(t)]}function q(t,n,e,r,i,a){h(o.updateContact,{type:2,id:t,gid:n,newgid:e},r,i,a)}function K(t,n,e,o,r){return sohu.mail.utils.isArray(t)!==!0?-1:void q(t.join(","),n,e,o,r,!0)}function L(t,n,e,r){var i,a;return sohu.mail.utils.isArray(t)!==!0?-1:(a=function(t){"function"==typeof e&&e(t)},i={type:2,id:t.join(","),newgid:n},void h(o.updateContact,i,a,r,!0))}function U(t,n,e,r){t.ajaxSubmit({url:o.importCSV+"?replace="+n,type:"POST",success:function(t){t.status?(tt=!0,e()):r()},error:r})}function J(n,e){t.ajax({url:o.importRemote,method:"POST",data:n}).done(function(t){"function"==typeof e&&e(t)})}function Q(t,n){tt=!0,v(t,n)}function z(){return H(e)}function H(t){var n=t.contact,e=t.recent,o=t.group,r={};r.recent=e;for(var i={},a=0,u=n.length;u>a;a++){var c=n[a],f={email:c.email,nickname:c.nickname};i[c.id]=f}for(var s=[],d=0,p=o.length;p>d;d++){var l=o[d],m=l.contactid?l.contactid.split(","):"",h=[];if(m)for(var v=0,g=m.length;g>v;v++){var y=m[v],C=i[y];h.push(C)}var G={};G.id=l.id,G.name=l.name,G.list=h,s.push(G)}return r.groups=s,r.contacts=n,r}function W(t){for(var n=t.contact,e={},o=0,r=n.length;r>o;o++){var i=n[o],a={id:i.id,nickname:i.nickname};e[i.email]=a}return e}function X(t,n){return Z.mapByMail?Z.mapByMail[t]?Z.mapByMail[t]:{}:void v(n)}function Y(){tt=!0}var Z=this,tt=!0,nt=!0,et={},ot={},rt=[],it=[],at=[],ut={},ct={},ft=function(t,n,e){var o={method:"get",url:t};if(e){var i=[];for(var a in e)!function(t){i.push(t+"="+e[t])}(a);o.url=o.url+"?"+i.join("&"),o.headers={"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}return r(o).success(function(t){n.resolve(t)}).error(function(){n.reject("There was an error")}),n.promise},st=function(t,n,e,o){var i=[];for(var a in n)!function(t){o?i.push(t+"="+JSON.stringify(n[t])):i.push(t+"="+n[t])}(a);r({method:"post",url:t,data:i.join("&"),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).success(function(t){e.resolve(t)}).error(function(){e.reject("There was an error")})},dt={requestType:"allContacts",gId:""};return Z.mapByMail=null,{log:function(t){},getAllContactsLength:function(){return rt.length},getRecentContactsLength:function(){return at.length},fetchData:v,getOriginData:Q,getContactsTree:z,toTreeData:H,getInfoByMail:X,getGroups:C,getFriendlyGroupInfo:G,getContacts:g,getRecentContacts:y,deleteContactsById:A,getGroupMembersById:D,createGroup:x,createGroup_v:F,updateGroup:E,deleteGroupById:V,searchGroupById:$,searchContactById:B,searchContactsByName:T,searchContactByEmail:k,getContactDetailById:R,moveContactsToGroup:K,addContactsToGroup:L,addContact:w,addContacts:I,deleteContactById:S,deleteContactByEmail:M,deleteContactsByName:O,importCSVContacts:U,importRemoteContacts:J,createGroupByDetial:P,searchContactFromRecent:j,fastAdd:_,getGroupName:b,getScore:N,stateParams:dt,setDirty:Y}}])}(jQuery);