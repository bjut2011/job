!function(){"use strict";var e=angular.module("writeMailModule");e.service("writeMailService",["$http","mAlert","configService","fileUploadService","setPublicMethod",function(e,t,n,a,r){var i=this,l={mail:"mail",attach:"attach",attachToken:"attach/token"};i.loginMail=n.email||localStorage.userid,i.externalData=null,i.fromForwardFirst=!1,i.attatchToken=null,i.subjectMaxCount=200,i.getSetting=function(){var e={autoSaveInterval:n.baseSet.autoSaveInterval,replyPrefix:n.baseSet.replyPrefix,includeOrigin:n.baseSet.includeOrigin};return e},void 0==n.baseSet.autoSaveInterval&&n.getBaseSet(),i.getPreDataForMail=function(){if(i.externalData){var e=angular.copy(i.externalData),t=e.data,n=e.type;t.display&&(t.content=t.display);var a,l={draftType:null,folderId:null,hasRead:null,isFwd:null,isReply:null,isSingle:null,isUrgent:null,origin:null,originId:null,originUid:null,display:null,receipt:null,receivedDate:null,send:null,sendDate:null,size:null,star:null};if("write"==n)$.extend(!0,t,l);else{t.from||(t.from=i.loginMail),t.originUid=t.from.getMailPure(),a=t.replyTo?t.replyTo:t.from,t.originId=t.id;var o=i.getSetting().replyPrefix,c='<p></p><p></p><p>----- 原始邮件 -----</p><p><p style="padding-bottom: 5px;"><b>发件人：</b>'+r.htmlTransferredMeaning(t.from)+"</p>"+(t.sendDate?'<p style="padding-bottom: 5px;"><b>发送时间：</b>'+t.sendDate.slice(0,-4)+"</p>":"")+'<p style="padding-bottom: 5px;"><b>收件人：</b>'+r.htmlTransferredMeaning(t.to.join(";"))+"</p>"+(t.cc&&t.cc.length?'<p style="padding-bottom: 5px;"><b>抄送：</b>'+r.htmlTransferredMeaning(t.cc.join(";"))+"</p>":"")+'<p style="padding-bottom: 5px;"><b>主 题：</b>'+t.subject+"</p></p>";switch(n){case"reply":t.to=[a],delete t.cc,delete t.bcc,t.attachments=[],t.draftType=2,i.getSetting().includeOrigin||(c="",t.content="");break;case"replyAll":t.to=i.getMailsNoSelf(t.to),t.to=i.getMailsNoOne(t.to,a),i.uniqueByPureMail(t.to),t.cc=i.getMailsNoSelf(t.cc),t.cc=i.getMailsNoOne(t.cc,a),t.to.splice(0,0,a),t.attachments=[],t.draftType=e.quickReply?3:2,i.getSetting().includeOrigin||(c="",t.content="");break;case"forward":i.fromForwardFirst=!0,delete t.to,delete t.cc,delete t.bcc,o="转发:",t.draftType=1}t.content=c+t.content,t.subject=(o+t.subject).slice(0,i.subjectMaxCount)}return delete t.id,delete t.from,t}},i.getMailsNoSelf=function(e){return i.getMailsNoOne(e,i.loginMail)},i.getMailsNoOne=function(e,t){if(!e||0==e.length)return e;var n=$.grep(e,function(e,n){return-1==e.indexOf(t.getMailPure())});return n},i.uniqueByPureMail=function(e){return $.uniqueExtend(e,function(e,t){return e.getMailPure()==t.getMailPure()})},i.getFormatMails=function(e,t){if(!e||0==e.length)return e;t||(t="or");for(var n,a,r,i=[],l=0;l<e.length;l++){switch(a=e[l].getMailNick(),r=e[l].getMailPure(),t){case"and":n=a+"<"+r+">";break;case"or":n=e[l].hasMailNick()?a+"<"+r+">":r;break;case"mail":n=r;break;case"nick":n=a}i.push(n)}return i},i.getContInsertSign=function(e,t,a){n.getSign(function(){var r=n.sign.trim();if(""!=r){var i="<br/><br/><br/><br/><br/><br/>",l="";"reply"==t&&(l="<br/>");var o=i+'<div sohumailsign style="margin:20px 0;" onclick="return false;">'+r+"</div>"+l;"new"==t?e+=o:"reply"==t&&(e=o+e)}a&&a(e)})},i.send=function(n,a,r){var i=0==n.send;for(var o in n)null==n[o]&&delete n[o];a||(a=function(){t.msg({type:"success",msg:"发送成功"})}),r||(r=function(){t.msg({type:"error",msg:"发送失败"})}),e.put(l.mail,n).success(function(e){var t=e.status;if("200"==t){var n=[];i&&n.push(e),a.apply(null,n)}else r(e)}).error(function(){r()})},i.getAttachToken=function(t,n,a){return i.attatchToken?void n(i.attatchToken):void e.get(l.attachToken+"?"+$.param(t)).success(function(e){var t=e.status,r=e.data;"200"==t?(i.attatchToken=r.token,n(i.attatchToken)):a(e)}).error(function(){a()})};i.delAttach=function(t,n,a){e({method:"delete",url:l.attach,data:t}).success(function(e){var t=e.status;e.data;"200"==t?n(e):a(e)}).error(function(){a()})},i.fileAble=window.File&&window.FileReader,i.attachUploadByAjax=function(e){e.url=l.attach,a.uploadByAjax(e)},i.attachUploadByIframe=function(e){var t={url:l.attach,progress:function(){},success:function(){},error:function(){},complete:function(){}};$.extend(!0,t,e),t.businessComplete=t.complete,t.complete=function(e){e&&e.status?t.success(e):t.error(e),t.businessComplete()},a.uploadByIframe(t)}}])}();