var App=angular.module("App",["ui.router","ng.ueditor","ngAnimate","model-box","fileUploadModel","loginModule","IndexModule","mailsModule","mailAddrRenderModule","writeMailModule","Contacts","SettingModule","selectModul","toolsBarModule","mailDetail","timeModel","httpModule","mailAccountModule","skinModule"]);App.run(["$rootScope","$state","$stateParams","$interval","authService","configService","httpService","setPublicMethod",function(t,e,a,i,l,s,r,n){t.$state=e,t.$on("$stateChangeStart",function(t,e,a,i,l){}),s.rootScope=t,t.$on("$stateChangeSuccess",function(t,e){}),t.$on("$viewContentLoaded",function(t,e){var a=$("input[placeholder],textarea[placeholder]");a&&a.length&&a.placeholder(),window.document.title="搜狐闪电邮箱";var i=localStorage.getItem("cssUrl");i&&($("#skinStyle").attr("href",i),$("#SkinClass").addClass(localStorage.getItem("cssName")))}),t.$stateParams=a;var o,c,u=!1;t.$on("autoReceive",function(){function t(){o=i(function(){s.sysMailCheckAndReceive(!0)},3e4)}function e(){({userid:n.getUserId(),priority:1});c=i(function(){s.multiMailPopAndReceive()},18e4)}u||(u=!0,t(),e())}),t.$on("autoReceiveCancel",function(){o&&(i.cancel(o),i.cancel(c),o=void 0,c=void 0)}),t.$on("scrollbar",function(e,a){t.$broadcast(a.flag,a)});var d,m,p;"undefined"!=typeof document.hidden?(d="hidden",p="visibilitychange",m="visibilityState"):"undefined"!=typeof document.mozHidden?(d="mozHidden",p="mozvisibilitychange",m="mozVisibilityState"):"undefined"!=typeof document.msHidden?(d="msHidden",p="msvisibilitychange",m="msVisibilityState"):"undefined"!=typeof document.webkitHidden&&(d="webkitHidden",p="webkitvisibilitychange",m="webkitVisibilityState"),n.EventUtil.addHandler(document,p,function(){"visible"===document[m]&&s.email&&s.email!==n.getUserId()&&location.reload()})}]),App.config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider","$sceDelegateProvider",function(t,e,a,i,l){l.resourceUrlWhitelist(["**"]),e.otherwise("login"),t.state("login",{url:"/login",views:{outMail:{templateUrl:"tpls/login.html"}}}).state("help",{url:"/help",views:{outMail:{templateUrl:"tpls/help.html"}}}).state("error",{url:"/error",views:{outMail:{templateUrl:"tpls/error.html"}}}).state("homepage",{url:"/homepage",views:{mailFrame:{templateUrl:"tpls/headerAndLeft.html"},mailContent:{templateUrl:"tpls/homepage.html"}}}).state("write",{url:"/write/:id",views:{mailFrame:{templateUrl:"tpls/headerAndLeft.html"},mailContent:{templateUrl:"tpls/write/write.html"}}}).state("sendstatus",{url:"/sendstatus/:flag",views:{mailFrame:{templateUrl:"tpls/headerAndLeft.html"},mailContent:{templateUrl:"tpls/write/sendstatus.html"}}}).state("mailaccounts",{url:"/mailaccounts/:popuserid",views:{mailFrame:{templateUrl:"tpls/headerAndLeft.html"},mailContent:{templateUrl:"tpls/mailaccounts/mailaccounts.html"}}}).state("mailaccounts.add",{url:"/add/:modifyId",templateUrl:"tpls/mailaccounts/mailac-add.html"}).state("setting",{url:"/setting",views:{mailFrame:{templateUrl:"tpls/headerAndLeft.html"},mailContent:{templateUrl:"tpls/setting/setting.html"}}}).state("setting.basic",{url:"/basic",templateUrl:"tpls/setting/set-basic.html"}).state("setting.addresserInfo",{url:"/addresser",templateUrl:"tpls/setting/set-addresserInfo.html"}).state("setting.autoreply",{url:"/autoreply",templateUrl:"tpls/setting/set-autoreply.html"}).state("setting.whitelist",{url:"/whitelist",templateUrl:"tpls/setting/set-whitelist.html"}).state("setting.blacklist",{url:"/blacklist",templateUrl:"tpls/setting/set-blacklist.html"}).state("setting.receiverule",{url:"/filter",templateUrl:"tpls/setting/set-receiverule.html"}).state("setting.newrule",{url:"/newrule/",templateUrl:"tpls/setting/set-receiverule.html"}).state("setting.setImgSignature",{url:"/imgSignature",templateUrl:"tpls/setting/set-imgSignature.html"}).state("setting.setPhoneServer",{url:"/phoneServer",templateUrl:"tpls/setting/set-phoneServer.html"}).state("setting.setPop",{url:"/pop",templateUrl:"tpls/setting/set-pop.html"}).state("skin",{url:"/skin",views:{mailFrame:{templateUrl:"tpls/headerAndLeft.html"},mailContent:{templateUrl:"tpls/skin/skin.html"}}}).state("contacts",{url:"/contacts",views:{mailFrame:{templateUrl:"tpls/headerAndLeft.html"},mailContent:{templateUrl:"tpls/contacts/contacts.html"}}}).state("contacts.list",{url:"/list/:requestType :gId",views:{"contactsView@contacts":{templateUrl:"tpls/contacts/list.html"}}}).state("contacts.add",{url:"/add",views:{"contactsView@contacts":{templateUrl:"tpls/contacts/add.html"}}}).state("contacts.detail",{url:"/detail/:contactId",views:{"contactsView@contacts":{templateUrl:"tpls/contacts/contactDetail.html"}}}).state("contacts.newGroup",{url:"/newGroup",views:{"contactsView@contacts":{templateUrl:"tpls/contacts/createGroup.html"}}}).state("contacts.editGroup",{url:"/editGroup/:gId",views:{"contactsView@contacts":{templateUrl:"tpls/contacts/createGroup.html"}}}).state("contacts.import",{url:"/importContacts",views:{"contactsView@contacts":{templateUrl:"tpls/contacts/importContacts.html"}}}).state("managefolder",{url:"/managefolder",views:{mailFrame:{templateUrl:"tpls/headerAndLeft.html"},mailContent:{templateUrl:"tpls/setting/set-managefolder.html"}}});var s=[{state:"recv",params:""},{state:"unread",params:""},{state:"starmail",params:""},{state:"spam",params:""},{state:"draft",params:""},{state:"send",params:""},{state:"delete",params:""},{state:"other",params:"/:folderId"},{state:"multiMails",params:"/:folderId"},{state:"searchMail",params:"/:searchText"}];angular.forEach(s,function(e){t.state(e.state,{url:"/"+e.state+e.params,views:{mailFrame:{templateUrl:"tpls/headerAndLeft.html"},mailContent:{templateUrl:"tpls/mail/mails.html"}}}).state(e.state+".mail",{url:"/:id",templateUrl:"tpls/mail/mailDetail.html",controller:"mailDetailCtrl",resolve:{mailData:["$stateParams","$http","getMailDetailService",function(t,e,a){return a.getMail(t.id)}]}})}),i.interceptors.push("authMailInterceptor")}]),App.factory("authMailInterceptor",["$q","mAlert",function(t,e){return{request:function(e){return"get"!==e.method.toLocaleLowerCase()||/(tpls|css|js|img|data)\//.test(e.url)||(~e.url.indexOf("?")?e.url+="&t="+(new Date).getTime():e.url+="?t="+(new Date).getTime()),e||t.when(e)},response:function(t){function a(){location.href="//"+location.host}function i(){var t=$("#quickPwd").val().trim();if(""==t)return void $("#quickPwd").focus();var i={username:r,password:md5(t),m:1},l=function(){delete $.needReLogin,e.close()},s=function(e){var i={account:r,pwd:t};e&&(i.res=e,localStorage.setItem("loginErr",JSON.stringify(i))),a()};$.ajax({url:"anoy/login",method:"post",contentType:"application/json",data:JSON.stringify(i),dataType:"json",success:function(t){var e=t.status,a=t.data;200==e?l(t):1050==e&&a&&a.bucketId?location.href="//mail.sohu.com/bapp/"+a.bucketId+"/main":s(t)},error:function(){s()}})}var l=t.data.status,s=t.data.data;if(/(anoy\/login|login\/|active$)/.test(t.config.url)&&1050==l&&s&&s.bucketId)return location.href="//mail.sohu.com/bapp/"+s.bucketId+"/main",t;if(601!=l||/(anoy\/login|login\/|active$)/.test(t.config.url))800==l&&e.alert({body:"系统错误，请刷新重试"});else{if(!localStorage.userid||!window.sessionStorage||!sessionStorage.getItem("sessionLogin"))return a(),t;$.needReLogin=!0;var r=localStorage.login?JSON.parse(localStorage.login).account:localStorage.userid;if(!r)return a(),!1;e.alert({title:"登录超时，请重新登录",body:'<form class="quick-login">                                    <div>用户名： '+r+'</div>                                    <div>密　码： <input id="quickPwd" type="password" maxlength="30"/></div>                                </form>',btns:[{"class":"btn-sure",text:"登录",closeDefer:!0,cb:function(){i()}},{"class":"btn-cancle",text:"取消",cb:function(){a()}}]}),$("#quickPwd").focus(),$("form.quick-login").off(),$("form.quick-login").on("submit",function(){return i(),!1})}return t},responseError:function(e){e.status;return t.reject(e)}}}]).provider("authService",function(){var t,e=this;e.$get=function(){return{getToken:function(){return t},setToken:function(e){t=e}}}}),App.service("configService",["$q","$http","$state","$stateParams","httpService","mAlert",function(t,e,a,i,l,s){var r=this;r.getMailFlag=!1,r.getMultiMailsFlag=!1,r.mailFolders={},r.folderNameIndex={},r.nowState="",r.foldersLength=0,r.quotaSize=0,r.totalMail=0,r.totalSize=0,r.validSize=0,r.totalUnread=0,r.baseSet={},r.sign="",r.failServeArr=[],r.mobile="",r.userSkin="",r.userDataFlag=!1,r.folderIndex={"未读邮件":"unread","收件箱":"recv","星标邮件":"starmail","草稿箱":"draft","已发送":"send","已删除":"delete","垃圾邮件":"spam"},r.getFolderListData=function(){var a=t.defer();return e.get("folders").success(function(t){if(200==t.status){var t=t.data,e=t.folders,i={multiMails:[],other:[]};r.foldersLength=e.length;for(var l=0;l<r.foldersLength;l++){var s=e[l],n=s.name,o="";"sys"===s.type&&(o=r.folderIndex[n]),r.folderNameIndex[s.folder_id]=s.name,o?r.mailFolders[o]=s:"sys"!=s.type&&i[s.type].push(s)}if(r.mailFolders.multiMails=i.multiMails,r.mailFolders.other=i.other,r.failServeArr.length)for(var c=0,u=r.mailFolders.multiMails.length;u>c;c++)for(var d=0,m=r.failServeArr.length;m>d;d++)if(r.mailFolders.multiMails[c].name===r.failServeArr[d].popuserid){r.mailFolders.multiMails[c].failRecive=!!r.failServeArr[d].status;break}r.quotaSize=t.quotaSize,r.totalMail=t.totalMail,r.totalSize=t.totalSize,r.validSize=t.quotaSize-t.totalSize,r.totalUnread=t.totalUnread,t.isUnlimited&&(r.quotaSize="无限大"),a.resolve("Folder Ready")}}),a.promise},r.getSkinUser=function(t){l.skin.getSkinUser().then(function(e){200==e.status&&(r.userSkin=e.data,t&&t())})},r.getNoticeFlag=!0,r.getNotice=function(t){r.getNoticeFlag&&l.index.getNotice().then(function(e){e&&e.data&&(r.getNoticeFlag=!1,t&&t())})},r.getUserData=function(t){r.userDataFlag?t&&t():l.index.getUserData().then(function(e){200==e.status&&(r.nickname=e.data.nickname||e.data.email.getMailNick(),r.email=e.data.email,r.score=e.data.score,r.lastLoginDate=e.data.lastLoginDate,r.viewMode=e.data.viewMode,r.multiMails=e.data.multiMails,r.mobile=e.data.mobile,localStorage.setItem("userid",r.email),sessionStorage.setItem("sessionLogin",1),t&&t(),r.userDataFlag=!0)})},r.getBaseSet=function(t){l.baseSet.get().then(function(e){200==e.status&&(r.baseSet.httpsFilter=e.data.httpsFilter||!!e.data.httpsFilter,r.baseSet.autoSaveContact=e.data.autoSaveContact,r.baseSet.autoSaveInterval=e.data.autoSaveInterval||3,r.baseSet.sessionMode=e.data.sessionMode||!!e.data.sessionMode,r.baseSet.showSenderAddr=e.data.showSenderAddr,r.baseSet.replyPrefix=e.data.replyPrefix||"回复:",r.baseSet.includeOrigin=e.data.includeOrigin||!!e.data.includeOrigin,r.baseSet.pageCount=e.data.pageCount||20,t&&t())})},r.getSign=function(t){l.sign.getSign().then(function(e){if(200==e.status){var a=e.data;if(a.imageSignature||a.signature){r.sign="";var i=a.imageSignatureUrl;i+=(/\?/.test(i)?"&":"?")+"t="+(new Date).getTime(),a.imageSignature&&(r.sign+='<img src="'+i+'"/>'),a.signature&&(r.sign+=a.signature)}t&&t()}})},r.sysMailCheckAndReceive=function(t,e){l.index.sysMailCheck().then(function(e){var i=e.status;if(200==i){var n,o=e.data,c=o.newmail;l.index.sysMailCheckParam.t=o.t,l.index.sysMailCheckParam.i=o.i,0==c?t||(n="没有新邮件"):(n="收到"+c+"封新邮件",r.getFolderListData(),r.rootScope.$broadcast("getList",o)),n&&s.msg({type:"success",msg:n}),t||a.go("recv")}r.getMailFlag=!1},function(){r.getMailFlag=!1})},r.multiMailPopAndReceive=function(t){if(r.mailFolders.multiMails&&r.mailFolders.multiMails.length){var e={userid:localStorage.getItem("userid"),priority:1};l.mailAccounts.getMail(e,function(t){r.getFolderListData(),r.getMultiMailsFlag=!1},function(t){r.failServeArr=t,s.msg({type:"error",msg:"代收邮箱收取失败"});for(var e=0,a=r.mailFolders.multiMails.length;a>e;e++)for(var i=0,l=t.length;l>i;i++)if(r.mailFolders.multiMails[e].name===t[i].popuserid){r.mailFolders.multiMails[e].failRecive=!!t[i].status;break}r.getMultiMailsFlag=!1})}else r.getMultiMailsFlag=!1}}]),App.service("loginService",["$http","mAlert",function(t,e){var a=this;a.login=function(e,a,i){a||(a=function(){}),i||(i=function(){}),t.post("anoy/login",e).success(function(t){var e=t.status;t.data;200==e||602==e?a(t):i(t)}).error(function(){i()})}}]),App.factory("getMailDetailService",["$http","$q","$state",function(t,e,a){return{getMail:function(i){var l=e.defer();return t.get("getMail?id="+i).success(function(t){t&&t.status&&200==t.status||(t=null,a.go(a.$current.name.replace(/\.mail/,""))),l.resolve(t)}).error(function(t){l.resolve(null)}),l.promise}}}]);