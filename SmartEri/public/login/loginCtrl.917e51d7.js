!function(){"use strict";var n=angular.module("loginModule",[]);n.controller("loginCtrl",["$scope","$rootScope","$state","$http","$sce","mAlert","loginService","httpService","setPublicMethod","$interval","$timeout",function(n,t,o,e,i,a,c,u,r,s,l){function p(){var t,o=n.account.trim(),e="@sohu.com",i="";return""==o?void(n.accountTipsShow=!1):(n.accountTipsShow=!0,t=o.indexOf("@")>-1?o.slice(o.indexOf("@")):null,void(!t||e.indexOf(t)>-1&&e!=t?(i=o.replace(/@.*/,"")+e,n.accountTipsData[0]=i):n.accountTipsShow=!1))}function d(){var t=localStorage.loginErr;t=t?JSON.parse(t):null,t&&(n.account=t.account,n.pwd=t.pwd,b(t.res),delete localStorage.loginErr)}function g(n){a.msg({type:"error",msg:n,baseSlct:"body"})}function m(){localStorage.getItem("needActive")&&e.post("active").success(function(n){var t=n.status;n.data;200==t?(delete localStorage.needActive,T()):201!=t&&204!=t||O('邮件自动激活失败，请<a href="http://register.mail.sohu.com/active/Reg5_new.jsp">手动激活</a>！')})}function h(){e.post("login/status").success(function(n){var t=n.status;n.data;200==t&&T()})}function f(){n.loginTip="";var t=n.account.toLowerCase().trim();if(""==t||""==n.pwd.trim())return n.loginTip="请输入账号密码",!1;if(!t.isMail()&&!/^\d{11}$/.test(t))return n.loginTip="请输入正确的邮箱地址",v("input[ng-model=account]"),!1;var o={username:t,password:md5(n.pwd),m:1,autologin:n.remember,captcha:n.captcha},e=function(n){var e={account:o.username,remember:o.autologin};t!==localStorage.getItem("login")&&localStorage.setItem("cssUrl",""),localStorage.setItem("login",JSON.stringify(e)),T()};n.loging=!0,c.login(o,e,b)}function b(t){if(n.loging=!1,!t||!t.status)return void g("登录失败，请稍候重试");var e=t.status,i={204:"请输入正确的账号密码",400:"请输入正确的账号密码",402:"请输入正确的账号密码",406:"本周登录次数过多，请下周再来登录",408:"请输入验证码",409:"验证码输入有误",600:"今日登录次数过多，请明天再来登录",800:"登录失败，请稍候重试"};if(408==e)n.needCaptcha=!0,v("input[ng-model=captcha]");else if(409==e)n.getCaptcha();else if(/^(600|406)$/.test(e))O(i[""+e]);else if(/^(1080|1081)$/.test(e)){var a=t.msg?t.msg:i[800];O(a)}else if(/^(1051|201)$/.test(e))o.go("error");else if(e){/^(204|400|402)$/.test(e)&&n.needCaptcha&&n.getCaptcha();var c=i[""+e];n.loginTip=c}}function v(n){n&&setTimeout(function(){$(n).focus()},10)}function T(){n.loging=!1,S()}function O(n){n||(n="您当前登录次数过多，请稍后重试"),a.alert({title:"提示",body:n})}function w(){o.go("homepage"),n.bindOption.timeout&&l.cancel(n.bindOption.timeout)}function S(){u.setAutoreply.bindQuery().then(function(t){if(200===Number(t.status)){if(t.data.mobile)return w(),!1;n.bindOption.count=t.data.count,!t.data.count&&n.bindOption.oneLogin?(n.bindOption.grayFlag=!0,w()):n.bindOption.showBindFlag=!0,n.bindOption.oneLogin=!1}})}function C(t){return n.bindOption.bindPhone?r.checkPhone(n.bindOption.bindPhone)?t&&(!n.bindOption.msgCaptcha||n.bindOption.msgCaptcha.length<6)?(g("请输入正确的验证码"),!1):!0:(g("请输入正确的手机号"),!1):(g("请输入手机号"),!1)}function y(){var t=60;n.bindOption.grayFlag=!0,n.bindOption.contentCaptcha="剩余"+t+"s";var o=s(function(){n.bindOption.contentCaptcha="剩余"+t+"s",t--,t||(n.bindOption.contentCaptcha="获取验证码",s.cancel(o),n.bindOption.grayFlag=!1)},1e3)}n.httpService=u,m(),h(),n.$emit("autoReceiveCancel"),n.loging=!1,n.needCaptcha=!1,n.captchaUrl="anoy/login/cap?"+(new Date).getTime(),n.account="",n.pwd="",n.remember=!1;var A,N=localStorage.login;N?(A=JSON.parse(N),n.remember=!!A.remember,n.account=A.account?A.account:"",v("input[ng-model=pwd]")):v("input[ng-model=account]"),n.loginTip="",n.accountAutoInput=function(t){if(50==t.keyCode){var o=n.account.trim();o.indexOf("@")+1==o.length&&(n.account=o+"sohu.com")}},n.inputChg=function(t){n.loginTip="",t&&"account"==t&&p()},n.loginSubmit=function(){return n.accountTipsShow?(n.accountTipSelect(),!1):n.loging?!1:(f(),!1)},n.getCaptcha=function(){n.captchaUrl=n.captchaUrl.replace(/\d+/,(new Date).getTime()),n.captcha="",v("input[ng-model=captcha]")},n.register=function(){var n="https://passport.sohu.com/signup?signupType=email&appid=1113&ppag=0&ru="+location.href;return localStorage.setItem("needActive","1"),location.href=n,!1},d(),n.accountTipsShow=!1,n.accountTipsData=[],n.accountBlurTipsHide=!0,n.accountTipSelect=function(){return n.account=n.accountTipsData[0],n.accountTipsShow=!1,v("input[ng-model=pwd]"),!1},n.accountTipRender=function(t){var o=n.account.trim(),e=t.replace(o,"<b>"+o+"</b>");return i.trustAsHtml(e)},n.accountFocus=function(){p()},n.accountBlur=function(){n.accountBlurTipsHide&&n.accountTipsShow&&(n.accountTipsShow=!1,n.account=n.accountTipsData[0])},n.accountTipMouseenter=function(t){n.accountBlurTipsHide=!1,v("input[ng-model=account]")},n.accountTipMouseleave=function(t){n.accountBlurTipsHide=!0},n.bindOption={showBindFlag:!1,count:"",msgCaptcha:"",bindPhone:"",contentCaptcha:"获取验证码",grayFlag:!1,bindOk:!1,timeout:"",oneLogin:!0},n.goHomepage=w,n.bindPhone=function(){C(!0)&&u.setAutoreply.bindPhone({phone:n.bindOption.bindPhone,captcha:n.bindOption.msgCaptcha}).then(function(t){200===Number(t.status)?(n.bindOption.bindOk=!0,n.bindOption.timeout=l(function(){w()},3e3)):g(400===Number(t.status)?"验证码错误":403===Number(t.status)?"手机号码已绑定，若有问题请拨打页面下方客服热线":406===Number(t.status)?"当前电话号码/IP/邮箱地址请求次数超过限制":"绑定失败")})},n.getPhoneCaptcha=function(){n.bindOption.grayFlag||C()&&u.setAutoreply.getVerCode({bindPhone:n.bindOption.bindPhone}).then(function(n){200===Number(n.status)?(S(),y()):g(406===Number(n.status)||412===Number(n.status)?"获取验证码次数过多，请稍后重试":403===Number(n.status)?"手机号码已绑定，若有问题请拨打页面下方客服热线":800===Number(n.status)?"发送短信失败":"绑定失败")})},n.$watch("bindOption.msgCaptcha",function(t,o,e){n.bindOption.msgCaptcha=r.checkNum(t)}),n.$watch("bindOption.bindPhone",function(t,o,e){n.bindOption.bindPhone=r.checkNum(t)})}]),n.directive("loginAd",function(){return{restrict:"AE",link:function(n,t,o){function e(n,t){for(var o=n,e="";t>0&&(t%2===1&&(e+=o),1!==t);)o+=o,t>>=1;return e}var i=angular.element("#changeTheme"),a=angular.element("#loginBody"),c=angular.element("#theme"),u=angular.element(".addFocus"),r=angular.element("#adHref");u.focus(function(){$(this).addClass("inside-box-shadow")}).blur(function(){u.removeClass("inside-box-shadow")}),n.nowIndex=0,n.imgLoopData=null,n.switchImg=function(t){if(n.imgLoopData){var o=n.imgLoopData;a.css({backgroundColor:o[t].backColor}),c.css({"background-image":'url("'+o[t].adSrc+'")'}),i.find("span").css({"background-color":"#AAAAAA"}),i.find("span").eq(t).css({"background-color":"#FFFFFF"}),r.attr("href",o[t].adUrl),i.find("span").length>1&&(n.nowIndex=t,n.imgLoopPlay())}},n.loopTimer=null,n.imgLoopPlay=function(){n.loopTimer&&clearTimeout(n.loopTimer),n.loopTimer=setTimeout(function(){var t=n.nowIndex+1;t>=i.find("span").length&&(t=0),n.switchImg(t)},5e3)},n.httpService.index.getAd().then(function(t){if(0===Number(t.status)){t=t.data;var o=t.login;n.imgLoopData=o,i.html(e("<span></span>",o.length)),n.switchImg(0),i.on("click","span",function(){var t=$(this).index();n.switchImg(t)}),o.length-1||i.hide()}})}}}),n.filter("phone",function(){return function(n){var t=/1(\d{2})\d{4}(\d{4})/g;return n.replace(t,"1$1****$2")}})}();