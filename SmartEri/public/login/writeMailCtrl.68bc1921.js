!function(){"use strict";var e=angular.module("writeMailModule",[]);e.controller("writeMailCtrl",["$scope","$rootScope","$state","$stateParams","mAlert","getMailDetailService","writeMailService","contactsService","mailAddrRenderService","configService","fileUploadService","setPublicMethod","httpService",function(e,t,a,i,n,r,o,l,c,s,d,m,u){function f(){if(s.multiMails.length>0){var t=[e.loginMail].concat(s.multiMails);e.fromSelArr=s.multiMails,e.fromSwitch=function(a){e.mail.from="<"+e.fromSelArr[a]+">";var i=e.mail.from.getMailPure();e.fromSelShow=!1,e.fromSelArr=$.grep(t,function(e,t){return e!=i})},e.toggleFromSel=function(){e.fromSelArr.length>0&&(e.fromSelShow=!e.fromSelShow)}}}function g(t){if(t=(t?t:e.recInput[e.recFlag]).trim(),""!=t){for(var a=re(t),i=!0,n=0,r=e.mail[e.recFlag].length;r>n;n++)if(a.text.getMailPure()===e.mail[e.recFlag][n].text.getMailPure()){i=!1;break}i?e.mail[e.recFlag].push(a):J("该联系人已经添加过了"),e.recInput[e.recFlag]=""}}function p(){setTimeout(function(){$(".receiver[flag="+e.recFlag+"]").find("input").focus()},10)}function h(t){e.validAttachSize=t;var a=ue-t;a=(Math.min(ue,a)/1024/1024).toFixed(1),e.validAttachSizeText=0>=a?"":a+"M/"}function v(){for(var t=e.mail.attachments,a=0,i=0;i<t.length;i++)a+=t[i].size;return a}function b(){var t=e.mail.attachments,a=[];if(t&&0!=t.length){for(var i in t)a.push(t[i].s3Id);return a}}function y(t){var a=e.mail.attachments,i=[];for(var n in a)i.push(a[n].name);return $.inArray(t,i)>-1}function S(t){var a=t.replace(/.+\./,"");return $.inArray(a,e.forbidFiles)>-1}function w(t){var a=t.value.replace(/.+[\\\/]/,"");if(y(a))return Z("已存在同名附件，请检查！"),t.value="",!1;if(S(a))return Z("禁止上传以下类型附件！<br>"+e.forbidFiles.join("、")),t.value="",!1;var i=e.mail.attachments.length,n={name:a,size:0,status:"pre",progress:0};e.mail.attachments.push(n),e.uploading||(e.uploadNowIndex=i,I())}function T(t){for(var a=t.files,i=0,n=e.mail.attachments.length,r=0;r<a.length;r++){var o={file:a[r],name:a[r].name,size:a[r].size,status:"pre",progress:0};0!=o.size?y(o.name)?J("已忽略同名附件"):S(o.name)?Z("已忽略禁止上传的附件类型！<br> ("+e.forbidFiles.join("、")+")"):o.size>e.validAttachSize?Z("总大小超限("+e.attachQuota+")，已忽略部分附件"):(i++,e.mail.attachments.push(o),h(e.validAttachSize-o.size)):J("已忽略大小为0KB的附件")}0!=i&&(e.uploading||(e.uploadNowIndex=n,I()))}function I(){var t={usedSize:e.oldAttachsSize};e.mail.id&&(t.id=e.mail.id),o.getAttachToken(t,function(t){e.attachToken=t,k()},function(t){var a="无法上传附件，请重试！";if(t&&t.status){var i=t.status,n={406:"上传频率太频繁，请稍候再试！",410:"对不起，您的可用空间已不足！"};n[i]&&(a=n[i])}e.mail.attachments[e.uploadNowIndex].status="forbidden",Z(a)})}function k(){e.uploading=!0;var t=e.uploadNowIndex,a={fileInputSlct:"#fileInputForAttach",data:{token:e.attachToken,file:e.mail.attachments[t].file},progress:function(a){e.$apply(function(){e.mail.attachments[t].progress=a.loaded/a.total*100})},success:function(a){var i=a.status,n=e.mail.attachments[t];if(200==i){var r=a.data;e.mail.subject||(e.mail.subject=r.name.slice(0,o.subjectMaxCount)),r.maxSize<e.validAttachSize&&h(r.maxSize),e.$apply(function(){delete n.file,n.status="ok",n.s3Id=r.id,n.name=r.name,n.contentType=r.contentType,n.size=r.size})}else{var l={407:"附件上传令牌已过期",417:"无法上传0KB附件，请检查",404:"上传附件已超过剩余大小限制("+e.attachQuota+")"},c=l[""+i]?l[""+i]:"附件上传失败，请重试！";Z(c),A(t)}},error:function(e){Z("附件上传失败，请重试！"),A(t)},complete:function(){e.mail.attachments[t];e.uploadNowIndex++,e.uploadNowIndex<e.mail.attachments.length&&"ok"!=e.mail.attachments[e.uploadNowIndex].status?I():(e.uploading=!1,x())}};e.fileAble?(delete a.fileInputSlct,o.attachUploadByAjax(a)):(delete a.data.file,a.extraData=a.data,delete a.data,o.attachUploadByIframe(a))}function A(t){var a=e.fileAble?"redo":"error",i=e.mail.attachments[t];e.$apply(function(){i.status=a})}function x(){for(var t,a=e.mail.attachments,i=0;i<a.length;i++)if(t=a[i],t.fakeDel&&!("pre"==t.status&&t.progress>0)){D(i);break}}function D(t){function a(){h(e.validAttachSize+l),e.uploading||(i.splice(t,1),x())}var i=e.mail.attachments,n=i[t],r=n.s3Id,l=n.size;n.status;return r?o.fromForwardFirst&&$.inArray(r,e.needCopyAttachs)>-1?void a():void o.delAttach({id:r,mailId:e.fromDraft?e.mail.id:void 0},function(){delete n.s3Id,a()},function(){delete n.s3Id,a()}):void a()}function F(){e.routerCheckOn=!1,a.go("draft")}function M(){e.mail.from_render=e.mail.from.getMailPure(),e.mail.to_render=oe(e.mail.to)||[],e.mail.cc_render=oe(e.mail.cc),e.mail.bcc_render=oe(e.mail.bcc),e.showTimingPicker=!!e.mail.timing,e.showTimingPicker&&(e.mail.timing=e.mail.timing.replace(/\:\d\d\.\d+/,"")),e.oldAttachsSize=v(),h(ue-e.oldAttachsSize),e.needCopyAttachs=o.fromForwardFirst?b():void 0,_()}function _(){if(o.fromForwardFirst||e.fromDraft)z();else{var t=o.externalData;t&&t.type&&/reply/.test(t.type)?o.getContInsertSign(e.mail.content,"reply",function(t){e.mail.content=t,z()}):o.getContInsertSign(e.mail.content,"new",function(t){e.mail.content=t,z()})}}function z(){e.draftCache=angular.copy(e.mail),e.routerCheckOn=!0}function C(t){t&&t.getContent&&e.draftCache&&(e.draftCache.content=t.getContent())}function P(){var t=e.mail,a=t.to_render,i=t.cc_render,n=t.bcc_render;if(a=a?a:[],i=i?i:[],n=n?n:[],0==a.length)return Z("收件人不能为空"),$(".recs input").focus(),!1;ce(a.concat(i,n));return a.length+i.length+n.length>20?(Z("最大收件人数量不能超过20，请检查后重新发送"),$(".recs input").focus(),!1):U(a)&&U(i,"抄送")?!!U(n,"密送"):!1}function U(e,t){if(!e)return!0;t=t?t+" - ":"";for(var a=0;a<e.length;a++){var i=e[a].text.getMailPure();if(!i.isMail())return Z(t+"收件人格式有误"),!1}return!0}function B(e){return e?e=$.grep(e,function(e,t){return 1==e.valid}):e}function j(){e.mail.to_render=B(e.mail.to_render),e.mail.cc_render=B(e.mail.cc_render),e.mail.bcc_render=B(e.mail.bcc_render)}function O(e){for(var t,a=[],i=0;i<e.length;i++)t={},$.extend(t,e[i]),t.s3Id&&t.name&&(t.id=t.s3Id,delete t.s3Id,delete t.url,delete t.maxSize,delete t.status,a.push(t));return a}function N(){e.mail.to=le(e.mail.to_render),e.mail.cc=le(e.mail.cc_render),e.mail.bcc=le(e.mail.bcc_render)}function R(e){Z("不存在此邮箱（"+e.getMailPure()+"），请检查")}function L(t,a){N(),e.mail.content=e.editor.getContent();var i={originId:e.mail.originId,originUid:e.mail.originUid,id:e.mail.id,from:e.mail.from,to:e.mail.to,isSingle:e.mail.isSingle?!0:void 0,cc:e.mail.cc,bcc:e.mail.bcc,subject:e.mail.subject,content:e.mail.content,attachments:O(e.mail.attachments),isReceipt:e.mail.isReceipt?!0:void 0,isUrgent:e.mail.isUrgent?!0:void 0,timing:e.showTimingPicker&&""!=e.mail.timing?e.mail.timing+":00.000":void 0,send:e.mail.send,draftType:e.mail.draftType};o.send(i,t,a)}function E(){""==e.mail.subject.trim()?n.alert({body:"确定不写主题就发送吗？",btns:[{"class":"btn-sure",text:"确定",cb:function(){K()}},{"class":"btn-cancle",text:"取消"}]}):K()}function K(){var t=e.mail.timing,a=7776e6;e.showTimingPicker&&t?new Date(t.replace(/-/g,"/"))<=new Date?n.alert({body:"您设置的发送时间已过期，<br>确定忽略定时直接发送吗？",btns:[{"class":"btn-sure",text:"确定",cb:function(){e.$apply(function(){e.showTimingPicker=!1,e.mai.timing=void 0}),Y()}},{"class":"btn-cancle",text:"取消"}]}):new Date(t.replace(/-/g,"/")).getTime()-(new Date).getTime()>a?(n.msg({type:"error",msg:"设定的日期超过了90天"}),e.mail.timing=""):Y():Y()}function Y(){e.mail.send=1;var t=function(){n.handRemoveMsg(),e.sending=!1,e.contactsTree=l.getOriginData(),a.go("sendstatus",{flag:e.showTimingPicker?"timing":null})},i=function(t){n.handRemoveMsg(),e.sending=!1;var a=t.status;if(415==a)R(t.data);else{var i="邮件发送失败，请重试！";1005==a&&(i="您发信过于频繁，请稍候重试！"),n.alert({body:i})}};n.msg({type:"success",msg:"正在发送，请稍候...",handMovement:!0,shade:!0}),e.sending=!0,L(t,i)}function H(t,a,i){if(!e.draftSaving){j(),e.draftSaving=!0,e.mail.send=0;var r=function(t){n.handRemoveMsg();var r=t.data;e.mail.id=r.index_id;var l=e.mail.attachments;if(r.transIds)for(var c in l)l[c].s3Id=r.transIds[c];o.fromForwardFirst=!1,e.fromDraft=!0,delete e.needCopyAttachs,e.draftSaving=!1,delete e.mail.draftType,delete e.mail.originId,delete e.mail.originUid,z(),n.msg({parent:".content",type:"success",msg:"已保存至草稿箱"}),a&&a(),i&&i()},l=function(){n.handRemoveMsg(),e.draftSaving=!1,t||n.msg({type:"error",msg:"草稿箱保存失败，请重试！"})};n.msg({type:"success",msg:"正在保存草稿，请稍候...",handMovement:!0,shade:!0}),L(r,l)}}function Q(){W(),s.getBaseSet(function(){e.draftSaveTimer=setInterval(function(){q()&&!V()&&e.saveDraft(!0)},60*o.getSetting().autoSaveInterval*1e3)})}function W(){e.draftSaveTimer&&clearInterval(e.draftSaveTimer)}function q(){var t=!1;N();var a=e.mail,i=a.attachments;return(a.to||a.cc||a.bcc||""!=a.subject.trim()||G()||i&&i.length>0)&&(t=!0),t}function G(){var t=e.mail,a=!1;return""!=$(t.content).not("div[sohumailsign]").text().trim()&&(a=!0),a}function V(){return angular.equals(e.draftCache,e.mail)}function Z(e){n.msg({type:"error",msg:e})}function J(e){n.msg({type:"success",msg:e})}function X(){W(),o.externalData=null,o.fromForwardFirst=!1,e.routerCheckOn=!1}e.showStatusView=!1,e.ie8=8==m.brower().ie;var ee,te,ae;e.stateDraftId=i.id,e.stateDraftId&&""!=e.stateDraftId||(e.stateDraftId=void 0);var ie=["Bold","fontfamily","fontsize","forecolor","backcolor","strikethrough","link","unlink","justifyleft","justifyright","justifycenter","date","removeformat","source"];if(e.ie8&&ie.splice(ie.length-2,1),e.imageUploadData={file:"",token:"",type:1,maxSize:-1},e.editor={},e.editorConfig={toolbars:[ie],fontsize:[10,11,12,14,16,18,20,24,36,48],initialFrameWidth:"100%",initialFrameHeight:480,scaleEnabled:!1,autoClearinitialContent:!0,disabledTableInTable:!1,allowDivTransToP:!1,wordCount:!1,catchRemoteImageEnable:!0,enableAutoSave:!1,autoHeightEnabled:!1,elementPathEnabled:!1,initialStyle:"p{line-height:1.5};.view{padding:0;word-wrap:break-word;cursor:text;height:90%;}body{margin:8px;font-family:Arial;font-size:14px;}p{margin:0 0;}",imageAllowFiles:[".png",".jpg",".jpeg",".gif",".bmp"],imageUploadUrl:"attach",imageApply:function(t){e.imageUploadData.maxSize=t.maxSize},imageError:function(e){"string"==typeof e?n.msg({type:"error",msg:e}):(410===Number(e.status)&&n.msg({type:"error",msg:"邮箱空间不足"}),406!==Number(e.status)&&400!==Number(e.status)||n.msg({type:"error",msg:"粘贴失败，请稍后重试"}))},getIimageUploadData:function(){return e.imageUploadData},imageGetToken:function(t){if(e.imageUploadData.token)return void t();var a={type:1};e.stateDraftId&&(a.id=e.stateDraftId),e.mail.inlineTotalSize&&(a.usedSize=e.mail.inlineTotalSize),u.writeMail.getToken(a).then(function(a){200===Number(a.status)?(e.imageUploadData.token=a.data.token,e.imageUploadData.maxSize=a.data.maxSize,t()):n.msg({type:"error",msg:"获取token失败"})},function(e){n.msg({type:"error",msg:"获取token失败"})})}},e.editorReady=function(e){e.getContent()&&e.focus()},e.editorAfterSetContent=function(e){C(e)},e.routerCheckOn=!1,e.writeMailService=o,e.loginMail=o.loginMail,e.mail={id:e.stateDraftId,from:"<"+e.loginMail+">",to:void 0,subject:"",content:"",attachments:[],isSingle:!1,cc:void 0,bcc:void 0,isUrgent:!1,isReceipt:!1,timing:"",send:0,draftType:void 0},e.fromSelArr=[],e.fromSelShow=!1,s.multiMails?f():s.getUserData(function(){f()}),e.showTimingPicker=!1,e.fromDraft=!!e.stateDraftId,o.externalData){var ne=o.getPreDataForMail();$.extend(e.mail,ne)}var re=c.getRecRender,oe=c.recToRenderArr,le=c.recToOriginArr,ce=c.uniqueByAddrObj;e.recInput={to_render:"",cc_render:"",bcc_render:""},e.recFlag="to_render",e.recType=[{key:"cc_render",addLabel:"抄送",delLabel:"取消抄送",disable:e.mail.isSingle},{key:"bcc_render",addLabel:"密送",delLabel:"取消密送",disable:e.mail.isSingle},{key:"isSingle",addLabel:"分送",delLabel:"取消分送",disable:!1}],e.recSwitch=function(t,a){if(!e.recType[a].disable){var i=e.mail[t];"isSingle"==t?(e.mail.isSingle=!i,e.recType[0].disable=e.recType[1].disable=e.mail.isSingle,i?(e.recType[0].grayFlag=!1,e.recType[1].grayFlag=!1,e.mail.to_render=angular.copy(ee),e.mail.cc_render=angular.copy(te),e.mail.bcc_render=angular.copy(ae),ee="",te="",ae=""):(e.recType[0].grayFlag=!0,e.recType[1].grayFlag=!0,ee=angular.copy(e.mail.to_render),te=angular.copy(e.mail.cc_render),ae=angular.copy(e.mail.bcc_render),e.mail.cc_render&&(e.mail.to_render=e.mail.to_render.concat(e.mail.cc_render)),e.mail.bcc_render&&(e.mail.to_render=e.mail.to_render.concat(e.mail.bcc_render)),ce(e.mail.to_render),e.mail.cc_render=void 0,e.mail.bcc_render=void 0),e.recFlag="to_render"):(e.mail[t]=i?void 0:[],e.recFlag=e.mail[t]?t:"to_render"),p()}},e.addrAppend=g,e.recInputOn=function(t){e.recFlag=$(t.target).closest(".receiver").attr("flag")},e.recInputStart=function(t){var a=$(t.target);(a.hasClass("label")||a.hasClass("recs")||a.parent().hasClass("recs"))&&(a.closest(".receiver").find("input").focus(),e.recFlag=$(t.currentTarget).attr("flag"))},e.keyboardAppend=function(t){var a=t.keyCode;13!=a&&32!=a||g(),8==a&&""==t.target.value&&e.mail[e.recFlag].pop()};var se=7776e6,de=new Date((new Date).getTime()+se),me={year:de.getFullYear(),month:de.getMonth()+1,day:de.getDate()};$("#timingPicker").datetimepicker({dayOfWeekStart:1,parentID:".opts-bar",yearStart:(new Date).getFullYear(),yearEnd:(new Date).getFullYear()+1,format:"Y-m-d H:i",step:10,minDate:0,maxDate:me.year+"/"+me.month+"/"+me.day}),e.optChose=function(t){"timing"==t?e.showTimingPicker=!e.showTimingPicker:e.mail[t]=!e.mail[t]};var ue=52428800;e.fileAble=o.fileAble,o.attatchToken=null,e.attachToken=null,e.validAttachSize=ue,e.attachQuota="50M",e.validAttachSizeText="";var fe=$("form.file-upload");e.fileBrowse=function(){e.fileAble&&$("form.file-upload input[type=file]").click()},e.uploadNowIndex=0,e.uploading=!1,fe.on("change","input[type=file]",function(){var t=this;e.fileAble?(T(t),$(this).after($(this).clone()),$(this).remove()):w(t)}),e.forbidFiles=["cmd","cpl","exe","hta","pif","scr","vbs","vsd"],e.reUpload=function(t){e.fileAble?(e.uploadNowIndex=t,e.mail.attachments[e.uploadNowIndex].status="pre",I()):(e.delAttach(t),setTimeout(function(){e.fileBrowse()},300))},e.delAttach=function(t){e.mail.attachments[t].fakeDel=!0,x()},e.stateDraftId?r.getMail(e.stateDraftId).then(function(t){t||(t={});var a=t.status;if(a&&200==a){var i=t.data;i.content=i.display,delete i.display,$.extend(e.mail,i),M()}else F()},function(e){F()}):M(),e.sending=!1,e.sendMail=function(){return!e.sending&&P()?e.uploading?void Z("附件上传中，请稍候..."):void E():void 0},e.draftSaving=!1,e.saveDraft=function(t){e.draftSaving||(e.showTimingPicker&&!t?n.alert({body:"草稿不会保存定时发送的时间，是否仍然保存草稿？",btns:[{"class":"btn-sure",text:"确定",cb:function(){e.$apply(function(){e.showTimingPicker=!1,e.mail.timing=void 0}),H(t)}},{"class":"btn-cancle",text:"取消"}]}):H(t))},Q(),e.writeCancel=function(){return 1==history.length?void a.go("homepage"):void history.back()},$(window).on("beforeunload",function(t){if(e.routerCheckOn&&"write"==a.current.name&&q()&&!$.needReLogin){var i;if(!V())return i="提醒：当前邮件还未保存至草稿箱！";if(e.stateDraftId!=e.mail.id)return i="当前页面数据将会丢失！\n您可以到草稿箱中找回此邮件！"}}),e.$on("$stateChangeStart",function(t,i,r,o,l){function c(){X(),r.id?a.go(i.name,{id:r.id}):a.go(i.name)}if("sendstatus"==i.name||"write"==i.name)return void X();if(e.routerCheckOn&&!V()){var s="当前邮件还未保存至草稿箱，确定要离开吗？";n.alert({body:s,btns:[{"class":"btn-sure",text:"离开并存草稿",closeDefer:!0,cb:function(){var e=function(){c(),n.close()},t=function(){};H(!1,e,t)}},{text:"离开不存草稿",cb:function(){c()}},{text:"取消"}]}),t.preventDefault()}else X()}),e.searchKey="",e.ctctSubOpen={recent:!1,groups:[],all:!0},e.contactsTree=null,l.getOriginData(function(t){e.contactsTree=l.getContactsTree();for(var a=e.contactsTree.groups,i=0;i<a.length;i++)e.ctctSubOpen.groups[i]=!1},function(e){}),e.contactsFilter=c.contactsFilter,e.joinRecInput=function(t,a,i){e.addrAppend(i+"<"+a+">"),p()},e.ctctSubListToggle=function(t,a){if("groups"==t){var i=e.ctctSubOpen[t];i[a]=!i[a]}else e.ctctSubOpen[t]=!e.ctctSubOpen[t]},e.seachInputChg=function(){var t=e.searchKey.trim();e.ctctSubOpen.recent=""!=t}}]),e.filter("byteSizeFilter",function(){return function(e,t){if(void 0==t&&(t=2),0===e)return"0B";var a,i=1024,n=["B","KB","MB","GB","TB","PB","EB","ZB","YB"];return a=Math.floor(Math.log(e)/Math.log(i)),(e/Math.pow(i,a)).toFixed(t)+n[a]}}),e.controller("sendstatusCtrl",["$scope","$rootScope","$state","$stateParams","mAlert","httpService",function(e,t,a,i,n,r){var o=i.flag;e.sendstatusAd={},e.isTiming=!1,o&&"timing"==o&&(e.isTiming=!0),e.toWrite=function(){a.go("write",{id:null})},e.toViewList=function(){e.isTiming?a.go("draft"):a.go("send")},r.index.getAd().then(function(t){0===Number(t.status)&&(e.sendstatusAd=t.data.sendstatus)})}])}();