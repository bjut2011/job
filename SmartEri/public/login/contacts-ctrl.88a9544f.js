!function(t){"use strict";var e=angular.module("Contacts",[]);e.controller("contactsCtrl",["$scope","$state","contactsService","mAlert",function(t,e,a,o){t.recentContacts="",t.allContacts="",t.contactsGroups="",t.recentContactsLength="",t.allContactsLength="",t.$update=function(){t.recentContacts=a.getRecentContacts(),t.allContacts=a.getContacts(),t.contactsGroups=a.getGroups(),t.recentContactsLength=a.getRecentContactsLength(),t.allContactsLength=a.getAllContactsLength();var e={flag:"contactsGroupsList",scrollEvent:"update"};setTimeout(function(){t.$emit("scrollbar",e)},100)},a.fetchData(function(e){t.$update()}),t.$on("updateGroup",function(e,a){t.$update()}),t.$on("selectLabel",function(t,e){var a={recentContacts:"showRecentContacts",allContacts:"showContacts",showGroup:""};setTimeout(function(){var t="#"+(a[e.requestType]?a[e.requestType]:e.gId);angular.element(".selectClick").removeClass("focus"),angular.element(t).addClass("focus")},0)}),t.addContact=function(){e.go("contacts.add")},t.showContacts=function(){e.go("contacts.list",{requestType:"allContacts"})},t.showRecentContacts=function(){e.go("contacts.list",{requestType:"recentContacts"})},t.showGroup=function(t){e.go("contacts.list",{requestType:"showGroup",gId:t.id})},t.deleteGroup=function(e){o.alert({title:"提示",body:'确定要删除"'+e.name+'"？',btns:[{"class":"btn-sure",text:"确定",cb:function(){a.deleteGroupById(e.id,function(){t.$update(),t.$broadcast("groupHasDeleted")})}},{"class":"btn-cancle",text:"取消"}]})},t.editGroup=function(t){e.go("contacts.editGroup",{gId:t.id})},t.createGroup=function(t){e.go("contacts.newGroup")}}]),e.controller("contactsListCtrl",["$scope","$state","$stateParams","mAlert","contactsService","writeMailService",function(t,e,a,o,n,c){function s(a,c,s){for(var r=s?"移动到组成功":"复制到组成功",i=[],l=0,u=a.length;u>l;l++)i.push(a[l].email);var p={gid:c,emails:i.join(",")};n.fastAdd(p,function(a){n.fetchData(function(){t.$update(),o.msg({type:"success",msg:r}),e.go("contacts.list",{requestType:"showGroup",gId:c})})},function(){o.msg({type:"error",msg:"操作失败，请稍后重试！"})})}function r(){t.contacts&&t.contacts.length&&t.contacts.sort(function(t,e){var a=t.nickname,o=e.nickname;return a.localeCompare(o)}),t.sortByDesc===!1?t.sortByDesc=!0:(t.sortByDesc=!1,t.contacts.reverse())}function i(){var e,a=[],c=[];if(t.contacts&&t.contacts.length){for(p=l(),e=0;e<p.length;++e)p[e].id?a.push(p[e].id):c.push(p[e].email);if(c.length)return void n.deleteContactsById(c,1,function(){t.isSelectedAll=!1,n.fetchData(function(){t.$update(),t.$emit("updateGroup",!0)})});n.deleteContactsById(a,function(){t.isSelectedAll=!1,n.fetchData(function(){t.$update(),t.$emit("updateGroup",!0)})})}else o.msg({type:"error",msg:"请选择联系人"})}function l(){var e,a,o=[];for(e=0;e<t.contacts.length;++e)!function(t){t.isSelected===!0&&(a={id:"",email:"",nickname:""},a.id=t.id,a.email=t.email,a.nickname=t.nickname,o.push(a))}(t.contacts[e]);return o}var u=a.requestType,p=[];t.sortByDesc=!1,n.stateParams.requestType=a.requestType,n.stateParams.gId=a.gId,t.contacts=null,t.isSelectedAll=!1,t.showPanel_1=!1,t.showPanel_2=!1,t.sendForbid=!0;var m=function(e){for(var a=e.score,o=-1,n=0,c=t.contacts.length;c>n;n++)if(t.contacts[n].email===e.email){o=n;break}var s=[["silver1"],["silver2"],["silver3"],["golden1"],["golden2"],["golden3"],["diamond1"],["diamond2"],["diamond3"],["crown1"],["crown2"],["crown3"]];if(~o)switch(!0){case 500>a:t.contacts[o].scoreType=s[0];break;case 900>a:t.contacts[o].scoreType=s[1];break;case 1500>a:t.contacts[o].scoreType=s[2];break;case 2700>a:t.contacts[o].scoreType=s[3];break;case 4500>a:t.contacts[o].scoreType=s[4];break;case 12500>a:t.contacts[o].scoreType=s[5];break;case 20500>a:t.contacts[o].scoreType=s[6];break;case 28500>a:t.contacts[o].scoreType=s[7];break;case 36500>a:t.contacts[o].scoreType=s[8];break;case 66500>a:t.contacts[o].scoreType=s[9];break;case 156e3>a:t.contacts[o].scoreType=s[10];break;default:t.contacts[o].scoreType=s[11]}};t.$update=function(){t.$parent.$update(),"recentContacts"===u?t.contacts=n.getRecentContacts():"showGroup"===u?t.contacts=n.getGroupMembersById(a.gId):t.contacts=n.getContacts(),t.$emit("selectLabel",a),r();var e=[];if(t.contacts&&t.contacts.length)for(var o=0,c=t.contacts.length;c>o;o++)~t.contacts[o].email.indexOf("sohu.com")&&e.push(t.contacts[o].email),t.contacts[o].scoreType=[];var s={email:e.join(",")};n.getScore(s).then(function(t){if(t&&t.length)for(var e=0,a=t.length;a>e;e++)m(t[e])});var i={flag:"listContent",scrollEvent:"update"};setTimeout(function(){t.$emit("scrollbar",i)},100)},n.fetchData(function(e){t.$update()},function(){o.msg({type:"error",msg:"地址薄服务请求失败"})}),t.closeModelPanel=function(){t.showPanel_1=!1,t.showPanel_2=!1},t.showGroupsPanel_1=function(){t.showPanel_2=!1,t.showPanel_1=!t.showPanel_1},t.showGroupsPanel_2=function(){t.showPanel_1=!1,t.showPanel_2=!t.showPanel_2},t.moveContactsToGroup=function(c){var r,i,u=[];for(i=a.gId,p=l(),r=0;r<p.length;++r)u.push(p[r].id);p.length>0?p[0].id?n.moveContactsToGroup(u,i,c,function(){t.$update(),e.go("contacts.list",{requestType:"showGroup",gId:c}),o.msg({type:"success",msg:"移动到组成功"})}):s(p,c,!0):o.msg({type:"error",msg:"请选择联系人"})},t.addContactsToGroup=function(a){var c,r=[];for(p=l(),c=0;c<p.length;++c)r.push(p[c].id);p.length>0?p[0].id?n.addContactsToGroup(r,a,function(){t.$update(),e.go("contacts.list",{requestType:"showGroup",gId:a}),o.msg({type:"success",msg:"复制到组成功"})}):s(p,a,!1):o.msg({type:"error",msg:"请选择联系人"})},t.autoSelect=function(){var e;if(t.isSelectedAll=!t.isSelectedAll,t.isSelectedAll)for(e=0;e<t.contacts.length;++e)t.contacts[e].isSelected=!0;else for(e=0;e<t.contacts.length;++e)t.contacts[e].isSelected=!1;t.sendForbid=!l().length},t.itemSelect=function(e){t.contacts[e].isSelected=!t.contacts[e].isSelected,t.sendForbid=!l().length},t.sendMail=function(){if(!t.sendForbid){var a,o=[];p=l();for(var n=0,s=p.length;s>n;++n)a=p[n].nickname+"<"+p[n].email+">",o.push(a);c.externalData={type:"write",data:{to:o}},e.go("write",{id:""})}},t.editContact=function(t){var a=t.id?t.id:encodeURIComponent(t.email);e.go("contacts.detail",{contactId:a})},t.deleteSelectedContacts=function(){t.contacts&&t.contacts.length?(p=l(),p.length>0?o.alert({title:"提示",body:"您确定要删除选中的联系人吗?",btns:[{"class":"btn-sure",text:"确定",cb:i},{"class":"btn-cancle",text:"取消"}]}):o.msg({type:"error",msg:"请选择联系人"})):o.msg({type:"error",msg:"请选择联系人"})},t.showNameByOrder=function(){r()},t.exportContactsBook=function(){n.exportContactsBook()}}]),e.controller("addContactCtrl",["$scope","$state","$stateParams","mAlert","contactsService","timeFunction","setPublicMethod",function(t,e,a,o,n,c,s){function r(){return t.contact.nickname.trim()?t.contact.personalemail?/[\\'"<>% ;]/.test(t.contact.nickname)?"联系人请不要输入;\\ \"<>% '空格等特殊字符":t.contact.personalemail.isMail()?t.contact.otheremail&&!t.contact.otheremail.isMail()?"备用邮箱格式不正确":t.contact.mobilephone&&!s.checkPhone(t.contact.mobilephone)?"手机号码不正确":t.contact.businessstreet&&/[\\'"% ;]/.test(t.contact.businessstreet)?"办公地址请不要输入;\\ \"% '空格等特殊字符":t.contact.personalstreet&&/[\\'"% ;]/.test(t.contact.personalstreet)?"住宅地址请不要输入;\\ \"% '空格等特殊字符":t.contact.notes&&/[\\'"% ;]/.test(t.contact.notes)?"备注请不要输入;\\ \"% '空格等特殊字符":!0:"邮箱格式不正确":"邮箱不能为空":"联系人不能为空"}var i="请选择";t.contact={fullname:"",nickname:"",personalemail:"",otheremail:"",ncGroup:"",mobilephone:"",otherphone:"",businessphone:"",fax:"",personalstreet:"",personalzip:"",businessstreet:"",businesszip:"",birthday:"",notes:"",homepage:"",type:4},t.groupLists=[],n.getGroups(function(e){t.groupLists=e;var a={flag:"addGrouplist",scrollEvent:"update"};setTimeout(function(){t.$emit("scrollbar",a)},100)}),t.groupIds=[],t.getGroup=function(e,a){a+="";var o=angular.element("#groupList").find(".ckbox").eq(e);o.hasClass("choosed")?(o.removeClass("choosed"),t.groupIds.splice(t.groupIds.indexOf(a),1)):(o.addClass("choosed"),t.groupIds.push(a))};c.getDate();t.birthdayYear={id:"contact-birthday-year",value:"",list:c.getYearLast(100),direction:!0},t.birthdayMonth={id:"contact-birthday-month",value:"",list:["01","02","03","04","05","06","07","08","09","10","11","12"],direction:!0},t.birthdayDay={id:"contact-birthday-day",value:"",list:["01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"],direction:!0},t.$watch("birthdayYear.value",function(e,a,o){var n=c.formatTime(t.birthdayYear.value,t.birthdayMonth.value,t.birthdayDay.value),s=c.getDayListAndDay(n);s&&(~s.list.indexOf(i)||s.list.unshift(i),t.birthdayDay.list=s.list,t.birthdayDay.value=s.value)}),t.$watch("birthdayMonth.value",function(e,a,o){var n=c.formatTime(t.birthdayYear.value,t.birthdayMonth.value,t.birthdayDay.value),s=c.getDayListAndDay(n);s&&(~s.list.indexOf(i)||s.list.unshift(i),t.birthdayDay.list=s.list,t.birthdayDay.value=s.value)}),t.$watch("contact.personalemail",function(e,a,o){e&&(t.contact.personalemail=s.filterMail(e))}),t.$watch("contact.otheremail",function(e,a,o){e&&(t.contact.otheremail=s.filterMail(e))}),t.$watch("contact.mobilephone",function(e,a,o){e&&(t.contact.mobilephone=s.checkNum(e))}),t.$watch("contact.businessphone",function(e,a,o){e&&(t.contact.businessphone=s.checkTel(e))}),t.$watch("contact.otherphone",function(e,a,o){e&&(t.contact.otherphone=s.checkTel(e))}),t.$watch("contact.personalzip",function(e,a,o){e&&(t.contact.personalzip=s.checkNum(e))}),t.saveOptions=function(){t.contact.ncGroup=t.groupIds.join(","),t.birthdayYear.value!==i&&t.birthdayMonth.value!==i&&t.birthdayDay.value!==i?t.contact.birthday=c.formatTime(t.birthdayYear.value,t.birthdayMonth.value,t.birthdayDay.value).slice(0,10):t.contact.birthday="0000-00-00";var a,s=!0;if(a=r(),a===!0){for(var l in t.allContacts)if(t.contact.personalemail===t.allContacts[l].email){s=!1;break}s?n.addContact(t.contact,function(a){o.msg({type:"success",msg:"保存成功"}),t.$parent.$update(),e.go("contacts.list")},function(t){o.msg({type:"error",msg:t.msg})}):o.msg({type:"error",msg:"邮箱重复，请重新填写"})}else o.msg({type:"error",msg:a})},t.cancelOptions=function(){history.go(-1)}}]),e.controller("showDetailCtrl",["$scope","$state","$stateParams","mAlert","contactsService","timeFunction","setPublicMethod",function(t,e,a,o,n,c,s){function r(e){n.getContactDetailById(e,function(e){if($.extend(!0,t.contact,e),t.originEmail=e.personalemail,t.contact.birthday&&"0000-00-00"!=t.contact.birthday){var a=t.contact.birthday.split("-");t.birthdayYear.value=a[0],t.birthdayMonth.value=a[1],t.birthdayDay.value=a[2]}t.groupIds=e.ncGroup.split(","),t.isChoosed=function(t){var a=e.ncGroup.split(",");return-1!==a.indexOf(""+t)}})}function i(){return t.contact.nickname.trim()?t.contact.personalemail?/[\\'"<>% ;]/.test(t.contact.nickname)?"联系人请不要输入;\\ \"<>% '空格等特殊字符":t.contact.personalemail.isMail()?t.contact.otheremail&&!t.contact.otheremail.isMail()?"备用邮箱格式不正确":t.contact.mobilephone&&!s.checkPhone(t.contact.mobilephone)?"手机号码不正确":t.contact.businessstreet&&/[\\'"% ;]/.test(t.contact.businessstreet)?"办公地址请不要输入;\\ \"% '空格等特殊字符":t.contact.personalstreet&&/[\\'"% ;]/.test(t.contact.personalstreet)?"住宅地址请不要输入;\\ \"% '空格等特殊字符":t.contact.notes&&/[\\'"% ;]/.test(t.contact.notes)?"备注请不要输入;\\ \"% '空格等特殊字符":!0:"邮箱格式不正确":"邮箱不能为空":"联系人不能为空"}var l="请选择";t.contact={fullname:"",nickname:"",personalemail:"",otheremail:"",ncGroup:"",mobilephone:"",otherphone:"",businessphone:"",fax:"",personalstreet:"",personalzip:"",businessstreet:"",businesszip:"",birthday:"",notes:"",homepage:"",type:1},t.originEmail="",t.groupLists=[],n.getGroups(function(e){t.groupLists=e;var a={flag:"detailGrouplist",scrollEvent:"update"};setTimeout(function(){t.$emit("scrollbar",a)},100)}),t.groupIds=[],t.getGroup=function(e,a){a+="";var o=angular.element("#groupList").find(".ckbox").eq(e);o.hasClass("choosed")?(o.removeClass("choosed"),t.groupIds.splice(t.groupIds.indexOf(a),1)):(o.addClass("choosed"),t.groupIds.push(a))};var u=decodeURIComponent(a.contactId);~u.indexOf("@")?n.fetchData(function(){var e=n.searchContactByEmail(u,!0);if(e)r(e.id);else{var a=n.searchContactFromRecent(u);t.contact.nickname=a.nickname||"",t.contact.personalemail=a.email||"",t.contact.type=4,t.isChoosed=function(t){return!1}}}):r(a.contactId),t.birthdayYear={id:"contact-birthday-year",value:"",list:c.getYearLast(100),direction:!0},t.birthdayMonth={id:"contact-birthday-month",value:"",list:["01","02","03","04","05","06","07","08","09","10","11","12"],direction:!0},t.birthdayDay={id:"contact-birthday-day",value:"",list:["01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"],direction:!0},t.$watch("birthdayYear.value",function(e,a,o){var n=c.formatTime(t.birthdayYear.value,t.birthdayMonth.value,t.birthdayDay.value),s=c.getDayListAndDay(n);s&&(~s.list.indexOf(l)||s.list.unshift(l),t.birthdayDay.list=s.list,t.birthdayDay.value=s.value)}),t.$watch("birthdayMonth.value",function(e,a,o){var n=c.formatTime(t.birthdayYear.value,t.birthdayMonth.value,t.birthdayDay.value),s=c.getDayListAndDay(n);s&&(~s.list.indexOf(l)||s.list.unshift(l),t.birthdayDay.list=s.list,t.birthdayDay.value=s.value)}),t.$watch("contact.personalemail",function(e,a,o){e&&(t.contact.personalemail=s.filterMail(e))}),t.$watch("contact.otheremail",function(e,a,o){e&&(t.contact.otheremail=s.filterMail(e))}),t.$watch("contact.mobilephone",function(e,a,o){e&&(t.contact.mobilephone=s.checkNum(e))}),t.$watch("contact.businessphone",function(e,a,o){e&&(t.contact.businessphone=s.checkTel(e))}),t.$watch("contact.otherphone",function(e,a,o){e&&(t.contact.otherphone=s.checkTel(e))}),t.$watch("contact.personalzip",function(e,a,o){e&&(t.contact.personalzip=s.checkNum(e))}),t.saveOptions=function(){t.contact.ncGroup=t.groupIds.join(","),t.birthdayYear.value!==l&&t.birthdayMonth.value!==l&&t.birthdayDay.value!==l?t.contact.birthday=c.formatTime(t.birthdayYear.value,t.birthdayMonth.value,t.birthdayDay.value).slice(0,10):t.contact.birthday="0000-00-00";var a,s=!0;if(a=i(),a===!0){for(var r in t.allContacts)if(t.contact.personalemail===t.allContacts[r].email&&t.originEmail!==t.contact.personalemail){s=!1;break}s?n.addContact(t.contact,function(a){o.msg({type:"success",msg:"保存成功"}),t.$parent.$update(),e.go("contacts.list",{requestType:n.stateParams.requestType,gId:n.stateParams.gId})},function(t){o.msg({type:"error",msg:t.msg})}):o.msg({type:"error",msg:"邮箱重复，请重新填写"})}else o.msg({type:"error",msg:a})},t.cancelOptions=function(){history.go(-1)}}]),e.controller("createGroupCtrl",["$scope","$state","$stateParams","mAlert","contactsService","setPublicMethod",function(t,e,a,o,n,c){function s(e){setTimeout(function(){t.$emit("scrollbar",{flag:"createcontactsPreview",scrollEvent:"update"}),e||t.$emit("scrollbar",{flag:"createcontactsGroup",scrollEvent:"update"})},100)}function r(e){var a,o,n,c=[],s=t.allContacts;for(n=0;n<s.length;++n)o="",a=s[n],o+=a.nickname+a.email,o.indexOf(e)>-1&&c.unshift({id:a.id,email:a.email,nickname:a.nickname,isNeedHide:!1});return c}function i(e){if(!e)return!1;for(var a=0,o=t.showGroups.length;o>a;++a)if(t.showGroups[a].id+""===e){t.newGroupName=t.showGroups[a].name,t.tempMember=t.tempMember.concat(t.showGroups[a].members),t.showGroups.splice(a,1);break}}var l,u="",p=!1;l=a.gId,t.showSearchResult=!1,t.newGroupName="",t.currentPosition="",t.searchKey="",t.showContactsList=[],t.showGroups=[],t.$on("groupHasDeleted",function(){t.$update()});var m=[];t.tempMember=[],i(l),t.$update=function(){t.$parent.$update(),t.showGroups=n.getFriendlyGroupInfo();var e=n.getContacts();e&&e.length&&(m=m.concat(e)),t.AllNumGroup=[{id:"0000000",name:"全部联系人",members:m}],t.showGroups=t.AllNumGroup.concat(t.showGroups),t.tempMember=[],t.currentPosition="",i(l),s()},n.fetchData(function(e){t.$update()}),t.clearPreview=function(){t.tempMember=[]},t.expendGroup=function(e){p=u===e&&p===!1,u=e,t.currentPosition=e,s()},t.isShow=function(t){return u===t&&!p},t.doSearch=function(){""===t.searchKey?t.showSearchResult=!1:(t.showContactsList=r(t.searchKey),t.showSearchResult=!0)},t.addToPreview=function(e){var a,n,c;if(e){for(c=!1,a=0,n=t.tempMember.length;n>a;++a)if(e.id==t.tempMember[a].id){o.msg({type:"error",msg:"已添加该联系人"}),c=!0;break}c||t.tempMember.unshift(e),s(!0)}},t.deleteFromPreviewGroup=function(e){var a,o;if(e){for(a=0,o=t.tempMember.length;o>a;++a)if(e.id==t.tempMember[a].id){t.tempMember.splice(a,1);break}s(!0)}},t.saveOptions=function(){var a,c=t.tempMember;a=t.newGroupName;var s="";if(a)if(/[\\'"% ;]/.test(a))o.msg({type:"error",msg:"组名称请不要输入\\\"% ' 等特殊字符"});else if(l){if(s=n.getGroupName(l),~s.indexOf(a))return o.msg({type:"error",msg:"组名称重复"}),!1;n.updateGroup({gid:l,name:a,members:c,success:function(a){t.$update(),o.msg({type:"success",msg:"保存成功"}),e.go("contacts.list",{requestType:"showGroup",gId:l})}})}else{if(s=n.getGroupName(),~s.indexOf(a))return o.msg({type:"error",msg:"组名称重复"}),!1;n.createGroup(a,c,function(a){t.$update(),o.msg({type:"success",msg:"保存成功"}),e.go("contacts.list",{requestType:"showGroup",gId:a})},function(){o.msg({type:"error",msg:"组创建失败"})})}else o.msg({type:"error",msg:"组名称不能为空"})},t.cancelOptions=function(){t.tempMember=[],history.go(-1)}}]),e.controller("importVendorMailCtrl",["$scope","$state","mAlert","contactsService",function(t,e,a,o){t.emailRegExp=/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/,t.mailForm={name:"",pass:"",domain:"",isSkip:!0},t.changeOption=function(e){t.mailForm.isSkip=e},t.sendMailForm=function(){var e=t.mailForm.name;return t.mailForm.isSkip="true"===t.mailForm.isSkip||t.mailForm.isSkip===!0,e?t.mailForm.pass?void(e&&(t.mailForm.domain=e.substring(e.indexOf("@"),e.length),o.importRemoteContacts({name:t.mailForm.name,passwd:t.mailForm.pass,servername:t.mailForm.domain,replace:t.mailForm.isSkip},function(t){t.status===!0||"true"===t.status?a.msg({type:"success",msg:"联系人导入成功！"}):a.msg({type:"error",msg:"联系人导入失败！"})}))):void a.msg({type:"error",msg:"密码位数应该在6-32位之间"}):void a.msg({type:"error",msg:"请输入正确的邮箱地址"})},t.clearMailForm=function(){t.mailForm={name:"",pass:"",isSkip:""}}}]),e.controller("importCSVCtrl",["$scope","$state","$element","mAlert","contactsService",function(t,e,a,o,n){var c="未选择任何文件";t.emailRegExp=/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/,t.replace=0,t.fileName=c,t.submit=function(){return t.fileName==c?void o.msg({type:"error",msg:"请选择文件"}):void n.importCSVContacts(a,t.replace,function(){o.msg({type:"success",msg:"联系人导入成功"}),e.go("contacts.list",{requestType:"allContacts"})},function(){o.msg({type:"error",msg:"联系人导入失败"})})},t.changeOption=function(e,a){t[e]=a},t.clearFileForm=function(){t.replace=0,t.fileName=c,history.back(-1)}}])}(void 0);